// GoMiniApp Database Schema
// Scalable, multi-tenant architecture for ride-hailing and future mini-apps

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
}

// =============================================================================
// GLOBAL APP CONFIG
// =============================================================================

model AppConfig {
  id               Int      @id @default(1)
  videoFeedListUri String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// =============================================================================
// SHARED: Users & Authentication
// =============================================================================

model User {
  id            String    @id @default(cuid())
  did           String    @unique // Bluesky DID (did:plc:xxx)
  handle        String?   // Bluesky handle (@user.bsky.social)
  pushToken     String?   // Expo push notification token
  pushTokenUpdatedAt DateTime?
  
  // Profile (cached from Bluesky)
  displayName   String?
  avatarUrl     String?
  
  // Role
  role          String    @default("USER") // USER, ADMIN
  
  // Settings
  defaultPaymentMethod String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  driver        Driver?
  marketSeller  MarketSeller?
  ordersAsUser  Order[]   @relation("UserOrders")
  ordersAsDriver Order[]  @relation("DriverOrders")
  ratings       Rating[]  @relation("RatingsGiven")
  ratingsReceived Rating[] @relation("RatingsReceived")
  savedPlaces   SavedPlace[]

  @@index([did])
  @@index([pushToken])
}

model SavedPlace {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String   // home, work, gym, etc.
  name        String
  address     String
  latitude    Float
  longitude   Float
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// GO SERVICE: Cities & Regional Pricing
// =============================================================================

model City {
  id          String   @id @default(cuid())
  code        String   @unique  // e.g., "DAKHLA", "LAAYOUNE", "CASA"
  name        String             // "Dakhla", "La√¢youne", "Casablanca"
  country     String   @default("MA")
  timezone    String?  @default("Africa/Casablanca")
  currency    String   @default("MAD")
  isActive    Boolean  @default(true)
  
  // Geofencing
  centerLatitude  Float
  centerLongitude Float
  radiusKm        Float    @default(50)  // Service radius from center
  
  // Display
  imageUrl    String?  // City banner/background image
  
  // Relations
  pricing     CityVehiclePricing[]
  drivers     Driver[]
  orders      Order[]
  walkthrough CityWalkthrough?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([centerLatitude, centerLongitude])
}

// =============================================================================
// GO SERVICE: City Walkthrough (Cinematic Tour)
// =============================================================================

model CityWalkthrough {
  id          String   @id @default(cuid())
  cityId      String   @unique
  city        City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  
  name        String?  // Optional name for the tour, e.g., "Dakhla Discovery"
  isActive    Boolean  @default(true)
  
  // Animation settings
  defaultDurationMs Int @default(3000)  // Default time per segment if not specified per point
  
  // Waypoints
  points      WalkthroughPoint[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WalkthroughPoint {
  id              String   @id @default(cuid())
  walkthroughId   String
  walkthrough     CityWalkthrough @relation(fields: [walkthroughId], references: [id], onDelete: Cascade)
  
  // Position in sequence (1, 2, 3...)
  order           Int
  
  // Camera position
  latitude        Float
  longitude       Float
  zoom            Float    @default(14)
  pitch           Float    @default(60)   // Tilt angle (0 = top-down, 60 = cinematic)
  bearing         Float    @default(0)    // Rotation/heading in degrees
  
  // Animation to this point
  durationMs      Int?     // Override walkthrough default if set
  
  // Optional label for admin reference
  label           String?  // e.g., "Marina View", "Old Town"
  
  // Rich content for tour stop display
  title           String?  // Display title shown during tour stop
  description     String?  // Description text shown during tour stop
  imageUrl        String?  // Image/media URL for the point
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([walkthroughId, order])
  @@index([walkthroughId])
}

model CityVehiclePricing {
  id              String   @id @default(cuid())
  cityId          String
  city            City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  vehicleTypeCode String   // References VehicleTypeConfig.code (ECONOMY, COMFORT, etc.)
  
  // Pricing overrides for this city
  baseFare        Float
  perKmRate       Float
  perMinuteRate   Float
  minimumFare     Float
  surgeMultiplier Float    @default(1.0)  // Dynamic pricing multiplier
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cityId, vehicleTypeCode])
  @@index([cityId, isActive])
}

// =============================================================================
// GO SERVICE: Drivers
// =============================================================================

model Driver {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // City assignment
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Availability
  isOnline        Boolean  @default(false)
  availabilityType AvailabilityType @default(BOTH)
  
  // Current Location (updated in real-time)
  currentLatitude  Float?
  currentLongitude Float?
  currentHeading   Float?   // Direction in degrees
  lastLocationUpdate DateTime?
  
  // Vehicle Info
  vehicleMake     String?
  vehicleModel    String?
  vehicleYear     Int?
  vehicleColor    String?
  licensePlate    String?
  vehicleType     String   @default("ECONOMY") // Dynamic vehicle type
  vehicleImageUrl String?   // Primary vehicle image URL
  
  // Stats
  rating          Float    @default(5.0)
  totalRides      Int      @default(0)
  totalDeliveries Int      @default(0)
  totalEarnings   Float    @default(0)
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isOnline, availabilityType])
  @@index([currentLatitude, currentLongitude])
  @@index([cityId])
}

enum AvailabilityType {
  RIDE
  DELIVERY
  BOTH
}

// VehicleType is now dynamic - stored as String and configured via VehicleTypeConfig table

// =============================================================================
// GO SERVICE: Orders (Rides & Deliveries)
// =============================================================================

model Order {
  id              String      @id @default(cuid())
  type            OrderType
  status          OrderStatus @default(PENDING)
  
  // City
  cityId          String?
  city            City?       @relation(fields: [cityId], references: [id])
  
  // Participants
  userId          String
  user            User        @relation("UserOrders", fields: [userId], references: [id])
  driverId        String?
  driver          User?       @relation("DriverOrders", fields: [driverId], references: [id])
  
  // Locations
  pickupLatitude  Float
  pickupLongitude Float
  pickupAddress   String
  pickupName      String?
  
  dropoffLatitude Float
  dropoffLongitude Float
  dropoffAddress  String
  dropoffName     String?
  
  // Route Info
  distanceKm      Float?
  durationMinutes Int?
  polyline        String?     // Encoded polyline for route display
  
  // Pricing
  vehicleType     String      @default("ECONOMY") // Dynamic vehicle type
  estimatedFare   Float
  finalFare       Float?
  surgeMultiplier Float       @default(1.0)
  
  // Delivery-specific
  packageSize     PackageSize?
  packageDescription String?
  isFragile       Boolean     @default(false)
  requiresSignature Boolean   @default(false)
  recipientName   String?
  recipientPhone  String?
  deliveryInstructions String?
  
  // Bluesky DM Integration
  conversationId  String?     // Bluesky conversation ID for order updates
  
  // Timestamps
  requestedAt     DateTime    @default(now())
  acceptedAt      DateTime?
  arrivedAt       DateTime?   // Driver arrived at pickup
  startedAt       DateTime?   // Trip/delivery started
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  cancelledBy     String?     // 'user' | 'driver' | 'system'
  
  // Relations
  events          OrderEvent[]
  rating          Rating?

  @@index([userId, status])
  @@index([driverId, status])
  @@index([status, requestedAt])
  @@index([pickupLatitude, pickupLongitude])
  @@index([cityId])
}

enum OrderType {
  RIDE
  DELIVERY
}

enum OrderStatus {
  PENDING           // Just created, searching for driver
  DRIVER_ASSIGNED   // Driver accepted
  DRIVER_ARRIVING   // Driver en route to pickup
  DRIVER_ARRIVED    // Driver at pickup location
  IN_PROGRESS       // Trip/delivery in progress
  COMPLETED         // Successfully completed
  CANCELLED         // Cancelled by user, driver, or system
}

enum PackageSize {
  SMALL       // Fits in hand
  MEDIUM      // Fits in backpack
  LARGE       // Needs car trunk
  EXTRA_LARGE // Needs van/truck
}

// =============================================================================
// GO SERVICE: Order Events (Real-time Tracking)
// =============================================================================

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  eventType OrderEventType
  
  // Location at time of event
  latitude  Float?
  longitude Float?
  
  // Additional data
  metadata  Json?    // Flexible storage for event-specific data
  
  createdAt DateTime @default(now())

  @@index([orderId, createdAt])
  @@index([eventType])
}

enum OrderEventType {
  CREATED
  DECLINED
  DRIVER_ASSIGNED
  DRIVER_LOCATION_UPDATE
  DRIVER_ARRIVING
  DRIVER_ARRIVED
  TRIP_STARTED
  TRIP_LOCATION_UPDATE
  TRIP_COMPLETED
  CANCELLED
  PAYMENT_PROCESSED
  RATING_SUBMITTED
  TIMEOUT
}

// =============================================================================
// GO SERVICE: Ratings
// =============================================================================

model Rating {
  id          String   @id @default(cuid())
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  fromUserId  String
  fromUser    User     @relation("RatingsGiven", fields: [fromUserId], references: [id])
  
  toUserId    String
  toUser      User     @relation("RatingsReceived", fields: [toUserId], references: [id])
  
  rating      Int      // 1-5 stars
  comment     String?
  tipAmount   Float?
  
  createdAt   DateTime @default(now())

  @@index([toUserId])
  @@index([fromUserId])
}

// =============================================================================
// PLATFORM: Mini-App Configurations (Future Extensibility)
// =============================================================================

model MiniApp {
  id          String   @id @default(cuid())
  appId       String   @unique // e.g., "go", "shop", "pay"
  name        String
  description String?
  iconUrl     String?
  isActive    Boolean  @default(true)
  
  // Settings stored as JSON for flexibility
  settings    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================================================
// GO SERVICE: Vehicle Type Configuration (Admin-managed ride types)
// =============================================================================

model VehicleTypeConfig {
  id            String   @id @default(cuid())
  code          String   @unique // ECONOMY, COMFORT, PREMIUM, XL, MOTO, BIKE, GREEN, etc.
  name          String   // Display name: "Go", "Comfort", "Black", etc.
  description   String   // Short description
  icon          String   // Emoji or icon identifier
  
  // Capacity
  capacity      Int      @default(4) // Number of passengers
  
  // Pricing
  baseFare      Float    @default(2.50)
  perKmRate     Float    @default(1.20)
  perMinuteRate Float    @default(0.15)
  minimumFare   Float    @default(5.00)
  
  // Display settings
  features      String[] @default([]) // ["4 seats", "AC", "Extra legroom"]
  sortOrder     Int      @default(0)  // Display order in UI
  isActive      Boolean  @default(true)
  isPromo       Boolean  @default(false)
  promoText     String?  // "Most popular", "New!", etc.
  
  // Vehicle requirements
  vehicleClass  String?  // For driver filtering: "sedan", "suv", "luxury", etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, sortOrder])
}

// =============================================================================
// PLATFORM: Push Notification Log (For debugging & analytics)
// =============================================================================

model PushNotificationLog {
  id          String   @id @default(cuid())
  userId      String
  
  title       String
  body        String
  data        Json?
  
  status      String   // 'sent', 'delivered', 'failed'
  errorMessage String?
  
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([status])
}

// =============================================================================
// LAREP: Infrastructure Projects Management
// =============================================================================

model LarepProject {
  id                String   @id @default(cuid())
  name              String   // Project name
  executor          String?  // Project executor/contractor
  budget            Float?   // Budget amount
  budgetCurrency    String   @default("MAD")
  executionPercent  Int      @default(0) // 0-100 percentage of completion
  description       String?  // Project description
  status            LarepProjectStatus @default(PLANNED)
  
  // Location center (for map display)
  centerLatitude    Float?
  centerLongitude   Float?
  
  // Tour/Walkthrough settings
  isPublished       Boolean  @default(false)
  defaultDurationMs Int      @default(3000)
  
  // Relations
  points            LarepProjectPoint[]
  images            LarepProjectImage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([isPublished])
}

enum LarepProjectStatus {
  PLANNED       // Not yet started
  IN_PROGRESS   // Currently being executed
  COMPLETED     // Finished
  ON_HOLD       // Temporarily paused
}

model LarepProjectPoint {
  id              String   @id @default(cuid())
  projectId       String
  project         LarepProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Position in sequence (1, 2, 3...)
  order           Int
  
  // Camera position
  latitude        Float
  longitude       Float
  zoom            Float    @default(14)
  pitch           Float    @default(60)
  bearing         Float    @default(0)
  
  // Animation to this point
  durationMs      Int?
  
  // Labels and content
  label           String?  // Admin reference label
  title           String?  // Display title for tour stop
  description     String?  // Description shown during tour
  imageUrl        String?  // Optional image for this point
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([projectId, order])
  @@index([projectId])
}

model LarepProjectImage {
  id          String   @id @default(cuid())
  projectId   String
  project     LarepProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  url         String   // Image URL
  caption     String?  // Image caption
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())

  @@index([projectId])
}

// =============================================================================
// MARKET: Sellers (Verified Publishers)
// =============================================================================

model MarketSeller {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Store Information
  storeName       String
  storeDescription String?
  contactPhone    String?
  contactEmail    String?
  
  // Verification Status
  status          MarketSellerStatus @default(PENDING)
  verifiedAt      DateTime?
  rejectionReason String?
  
  // Relations
  posts           MarketPost[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
}

enum MarketSellerStatus {
  PENDING     // Awaiting admin approval
  APPROVED    // Can publish posts to market
  REJECTED    // Application rejected
  SUSPENDED   // Temporarily suspended
}

// =============================================================================
// MARKET: Posts (Bluesky posts flagged for market display)
// =============================================================================

model MarketPost {
  id              String   @id @default(cuid())
  sellerId        String
  seller          MarketSeller @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  // Bluesky Post Reference
  postUri         String   @unique  // at://did:plc:xxx/app.bsky.feed.post/xxx
  postCid         String             // Content ID for the post
  
  // Category
  categoryId      String
  category        MarketCategory @relation(fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     MarketSubcategory? @relation(fields: [subcategoryId], references: [id])
  
  // Product Info (cached from post or provided separately)
  title           String
  description     String?
  price           Float?
  currency        String   @default("MAD")
  
  // Inventory Tracking
  quantity        Int      @default(1)
  soldCount       Int      @default(0)
  isInStock       Boolean  @default(true)
  
  // Status
  status          MarketPostStatus @default(PENDING_REVIEW)
  reviewedAt      DateTime?
  rejectionReason String?
  
  // Archived (for edits - new post replaces old)
  isArchived      Boolean  @default(false)
  replacedById    String?  // ID of the post that replaced this one
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sellerId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([status])
  @@index([isArchived])
}

enum MarketPostStatus {
  PENDING_REVIEW  // Awaiting admin approval
  ACTIVE          // Visible in market
  REJECTED        // Rejected by admin
  SOLD            // Marked as sold
  REMOVED         // Removed by seller
}

// =============================================================================
// MARKET: Categories & Subcategories
// =============================================================================

model MarketCategory {
  id              String   @id @default(cuid())
  name            String   @unique
  nameAr          String?  // Arabic name
  description     String?
  
  // Display
  emoji           String?  // Emoji icon (optional)
  iconUrl         String?  // SVG icon URL (admin uploaded)
  gradientStart   String?  // Gradient start color (hex)
  gradientEnd     String?  // Gradient end color (hex)
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  
  // Relations
  subcategories   MarketSubcategory[]
  posts           MarketPost[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive, sortOrder])
}

model MarketSubcategory {
  id              String   @id @default(cuid())
  categoryId      String
  category        MarketCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name            String
  nameAr          String?  // Arabic name
  description     String?
  
  // Display
  emoji           String?
  iconUrl         String?
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  
  // Relations
  posts           MarketPost[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([categoryId, name])
  @@index([categoryId, isActive, sortOrder])
}
