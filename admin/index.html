<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMiniApp Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .config {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .config button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .config button:hover {
            background: #0056b3;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stats-card .value {
            font-size: 32px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš— GoMiniApp Admin Panel</h1>
            <div class="config">
                <input type="text" id="apiUrl" placeholder="API URL" value="http://localhost:3001">
                <button onclick="saveConfig()">Save Config</button>
                <span id="configStatus"></span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('users')">Users</button>
            <button class="tab" onclick="showTab('drivers')">Drivers</button>
            <button class="tab" onclick="showTab('orders')">Orders</button>
            <button class="tab" onclick="showTab('add-driver')">Add Driver</button>
        </div>

        <div id="dashboard" class="section active">
            <h2>Dashboard</h2>
            <div class="grid" style="margin-top: 20px;">
                <div class="stats-card">
                    <h3>Total Users</h3>
                    <div class="value" id="totalUsers">0</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3>Total Drivers</h3>
                    <div class="value" id="totalDrivers">0</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3>Online Drivers</h3>
                    <div class="value" id="onlineDrivers">0</div>
                </div>
                <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3>Total Orders</h3>
                    <div class="value" id="totalOrders">0</div>
                </div>
            </div>
        </div>

        <div id="users" class="section">
            <h2>All Users</h2>
            <button class="btn" onclick="loadUsers()">Refresh</button>
            <div id="usersMessage"></div>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>DID</th>
                        <th>Handle</th>
                        <th>Display Name</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                </tbody>
            </table>
        </div>

        <div id="drivers" class="section">
            <h2>All Drivers</h2>
            <button class="btn" onclick="loadDrivers()">Refresh</button>
            <div id="driversMessage"></div>
            <table id="driversTable">
                <thead>
                    <tr>
                        <th>DID</th>
                        <th>Handle</th>
                        <th>Vehicle</th>
                        <th>License Plate</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Rating</th>
                    </tr>
                </thead>
                <tbody id="driversBody">
                </tbody>
            </table>
        </div>

        <div id="orders" class="section">
            <h2>Recent Orders</h2>
            <button class="btn" onclick="loadOrders()">Refresh</button>
            <div id="ordersMessage"></div>
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Pickup</th>
                        <th>Dropoff</th>
                        <th>Fare</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                </tbody>
            </table>
        </div>

        <div id="add-driver" class="section">
            <h2>Register New Driver</h2>
            <div id="addDriverMessage"></div>
            
            <div class="form-group">
                <label>DID *</label>
                <input type="text" id="did" placeholder="did:plc:xxxxx" required>
            </div>

            <div class="form-group">
                <label>Handle *</label>
                <input type="text" id="handle" placeholder="user.bsky.social" required>
            </div>

            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="displayName" placeholder="John Driver">
            </div>

            <div class="grid">
                <div class="form-group">
                    <label>Vehicle Type *</label>
                    <select id="vehicleType" required>
                        <option value="ECONOMY">Economy</option>
                        <option value="COMFORT">Comfort</option>
                        <option value="PREMIUM">Premium</option>
                        <option value="XL">XL</option>
                        <option value="MOTO">Moto</option>
                        <option value="BIKE">Bike</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>License Plate *</label>
                    <input type="text" id="licensePlate" placeholder="ABC123" required>
                </div>
            </div>

            <div class="grid">
                <div class="form-group">
                    <label>Vehicle Make</label>
                    <input type="text" id="vehicleMake" placeholder="Toyota">
                </div>

                <div class="form-group">
                    <label>Vehicle Model</label>
                    <input type="text" id="vehicleModel" placeholder="Camry">
                </div>
            </div>

            <div class="grid">
                <div class="form-group">
                    <label>Vehicle Color</label>
                    <input type="text" id="vehicleColor" placeholder="Silver">
                </div>

                <div class="form-group">
                    <label>Availability Type *</label>
                    <select id="availabilityType" required>
                        <option value="BOTH">Both Ride & Delivery</option>
                        <option value="RIDE">Ride Only</option>
                        <option value="DELIVERY">Delivery Only</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="registerDriver()">Register Driver</button>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('apiUrl') || 'http://localhost:3001';
        document.getElementById('apiUrl').value = API_URL;

        function saveConfig() {
            API_URL = document.getElementById('apiUrl').value;
            localStorage.setItem('apiUrl', API_URL);
            document.getElementById('configStatus').textContent = 'âœ“ Saved';
            setTimeout(() => {
                document.getElementById('configStatus').textContent = '';
            }, 2000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'users') loadUsers();
            if (tabName === 'drivers') loadDrivers();
            if (tabName === 'orders') loadOrders();
        }

        async function loadDashboard() {
            try {
                const [usersRes, driversRes] = await Promise.all([
                    fetch(`${API_URL}/api/admin/stats/users`).catch(() => ({json: () => ({data: {total: 0}})})),
                    fetch(`${API_URL}/api/admin/stats/drivers`).catch(() => ({json: () => ({data: {total: 0, online: 0}})}))
                ]);

                // For now, use database queries or estimate
                document.getElementById('totalUsers').textContent = 'â€”';
                document.getElementById('totalDrivers').textContent = 'â€”';
                document.getElementById('onlineDrivers').textContent = 'â€”';
                document.getElementById('totalOrders').textContent = 'â€”';
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        async function loadUsers() {
            showMessage('usersMessage', 'Loading...', 'success');
            try {
                // Since we don't have a list users endpoint, show placeholder
                document.getElementById('usersBody').innerHTML = '<tr><td colspan="4">User list endpoint not implemented. Use database query or add admin endpoints.</td></tr>';
                showMessage('usersMessage', 'Note: Add GET /api/admin/users endpoint for full functionality', 'error');
            } catch (error) {
                showMessage('usersMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function loadDrivers() {
            showMessage('driversMessage', 'Loading...', 'success');
            try {
                // Placeholder - needs admin endpoint
                document.getElementById('driversBody').innerHTML = '<tr><td colspan="7">Driver list endpoint not implemented. Use database query or add admin endpoints.</td></tr>';
                showMessage('driversMessage', 'Note: Add GET /api/admin/drivers endpoint for full functionality', 'error');
            } catch (error) {
                showMessage('driversMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function loadOrders() {
            showMessage('ordersMessage', 'Loading...', 'success');
            try {
                // Placeholder
                document.getElementById('ordersBody').innerHTML = '<tr><td colspan="7">Orders list endpoint not implemented. Use database query or add admin endpoints.</td></tr>';
                showMessage('ordersMessage', 'Note: Add GET /api/admin/orders endpoint for full functionality', 'error');
            } catch (error) {
                showMessage('ordersMessage', 'Error: ' + error.message, 'error');
            }
        }

        async function registerDriver() {
            const did = document.getElementById('did').value;
            const handle = document.getElementById('handle').value;
            const displayName = document.getElementById('displayName').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;
            const vehicleMake = document.getElementById('vehicleMake').value;
            const vehicleModel = document.getElementById('vehicleModel').value;
            const vehicleColor = document.getElementById('vehicleColor').value;
            const availabilityType = document.getElementById('availabilityType').value;

            if (!did || !handle || !licensePlate) {
                showMessage('addDriverMessage', 'Please fill required fields (DID, Handle, License Plate)', 'error');
                return;
            }

            try {
                showMessage('addDriverMessage', 'Registering user...', 'success');

                // Step 1: Login/register user
                const loginRes = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ did, handle, displayName: displayName || handle })
                });

                const loginData = await loginRes.json();
                if (!loginData.success) throw new Error('Login failed');

                const token = loginData.data.token;

                showMessage('addDriverMessage', 'Registering driver...', 'success');

                // Step 2: Register as driver
                const driverRes = await fetch(`${API_URL}/api/drivers/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        vehicleType,
                        licensePlate,
                        vehicleMake,
                        vehicleModel,
                        vehicleColor,
                        availabilityType
                    })
                });

                const driverData = await driverRes.json();
                if (!driverData.success) throw new Error(driverData.error?.message || 'Driver registration failed');

                showMessage('addDriverMessage', 'âœ“ Driver registered successfully! DID: ' + did, 'success');

                // Clear form
                document.getElementById('did').value = '';
                document.getElementById('handle').value = '';
                document.getElementById('displayName').value = '';
                document.getElementById('licensePlate').value = '';
                document.getElementById('vehicleMake').value = '';
                document.getElementById('vehicleModel').value = '';
                document.getElementById('vehicleColor').value = '';

            } catch (error) {
                showMessage('addDriverMessage', 'Error: ' + error.message, 'error');
            }
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.className = `message ${type}`;
            el.textContent = message;
            el.style.display = 'block';
        }

        // Load dashboard on startup
        loadDashboard();
    </script>
</body>
</html>
