<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoMiniApp Admin Panel</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #f8f9fa;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 -2px 0 #667eea inset;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        input[type="text"],
        input[type="search"],
        select {
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        input[type="search"] {
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .stat-card.purple { border-color: #667eea; }
        .stat-card.green { border-color: #10b981; }
        .stat-card.blue { border-color: #3b82f6; }
        .stat-card.orange { border-color: #f59e0b; }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f9fafb;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .debug-section {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 10px 0;
        }

        .debug-section pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Upload Zone Styles */
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .upload-zone.has-image {
            border-style: solid;
            border-color: #10b981;
            padding: 8px;
        }

        .upload-preview {
            text-align: center;
            color: #6b7280;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-preview img {
            max-width: 100%;
            max-height: 130px;
            border-radius: 8px;
            object-fit: cover;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 8px;
            display: block;
        }

        .upload-preview span {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó GoMiniApp Admin Panel</h1>
        <div class="subtitle">Database Management & Driver Administration</div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
            <button class="tab" onclick="showTab('debug', event)">üîç Debug</button>
            <button class="tab" onclick="showTab('users', event)">üë• Users</button>
            <button class="tab" onclick="showTab('drivers', event)">üöï Drivers</button>
            <button class="tab" onclick="showTab('orders', event)">üì¶ Orders</button>
            <button class="tab" onclick="showTab('vehicleTypes', event)">üöó Vehicle Types</button>
            <button class="tab" onclick="showTab('cities', event)">üèôÔ∏è Cities</button>
            <button class="tab" onclick="showTab('market', event)">üõçÔ∏è Market</button>
            <button class="tab" onclick="showTab('wallet', event)">üí≥ Wallet</button>
            <button class="tab" onclick="showTab('videoFeed', event)">üì∫ Video Feed</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <h2>Dashboard</h2>
            <div id="dashboardMessage" class="message"></div>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card purple">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="statUsers">-</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Total Drivers</div>
                    <div class="stat-value" id="statDrivers">-</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Online Drivers</div>
                    <div class="stat-value" id="statOnlineDrivers">-</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="statOrders">-</div>
                </div>
            </div>
        </div>

        <!-- Debug -->
        <div id="debug" class="section">
            <h2>Database Debug</h2>
            <div id="debugMessage" class="message"></div>
            
            <div class="toolbar">
                <button class="btn btn-primary" onclick="testConnection()">Test Connection</button>
                <button class="btn btn-primary" onclick="listTables()">List Tables</button>
                <button class="btn btn-primary" onclick="loadStats()">Load Stats</button>
            </div>

            <div id="debugOutput" class="debug-section" style="display:none;">
                <pre id="debugContent"></pre>
            </div>
        </div>

        <!-- Users -->
        <div id="users" class="section">
            <h2>Users</h2>
            <div id="usersMessage" class="message"></div>
            
            <div class="toolbar">
                <input type="search" id="userSearch" placeholder="Search by DID, handle, or name...">
                <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh</button>
            </div>

            <div id="usersTable"></div>
            <div id="usersPagination" class="pagination"></div>
        </div>

        <!-- Drivers -->
        <div id="drivers" class="section">
            <h2>Drivers</h2>
            <div id="driversMessage" class="message"></div>
            
            <div class="toolbar">
                <button class="btn btn-success" onclick="showCreateDriver()">‚ûï Create Driver</button>
                <select id="driverFilter" onchange="loadDrivers()">
                    <option value="">All Drivers</option>
                    <option value="true">Online Only</option>
                    <option value="false">Offline Only</option>
                </select>
                <button class="btn btn-primary" onclick="loadDrivers()">üîÑ Refresh</button>
            </div>

            <div id="driversTable"></div>
            <div id="driversPagination" class="pagination"></div>
        </div>

        <!-- Orders -->
        <div id="orders" class="section">
            <h2>Orders</h2>
            <div id="ordersMessage" class="message"></div>
            
            <div class="toolbar">
                <button class="btn btn-success" onclick="showCreateOrder()">‚ûï Create Order</button>
                <select id="orderFilter" onchange="loadOrders()">
                    <option value="">All Orders</option>
                    <option value="PENDING">Pending</option>
                    <option value="DRIVER_ASSIGNED">Assigned</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
                <button class="btn btn-primary" onclick="loadOrders()">üîÑ Refresh</button>
            </div>

            <div id="ordersTable"></div>
            <div id="ordersPagination" class="pagination"></div>
        </div>

        <!-- Vehicle Types -->
        <div id="vehicleTypes" class="section">
            <h2>Vehicle Types</h2>
            <div id="vehicleTypesMessage" class="message"></div>
            
            <div class="toolbar">
                <button class="btn btn-success" onclick="showCreateVehicleType()">+ Add Vehicle Type</button>
                <button class="btn btn-primary" onclick="loadVehicleTypes()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="seedVehicleTypes()">üå± Seed Defaults</button>
            </div>

            <div id="vehicleTypesTable"></div>
        </div>
    </div>

    <!-- Edit Driver Modal -->
    <div id="editDriverModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>Edit Driver</h3>
            <form id="editDriverForm">
                <input type="hidden" id="editDriverDid">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Left Column - Basic Info -->
                    <div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editDriverOnline">
                                <option value="true">Online</option>
                                <option value="false">Offline</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Type</label>
                            <select id="editDriverVehicleType">
                                <!-- Dynamic options populated via JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>License Plate</label>
                            <input type="text" id="editDriverPlate">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Make</label>
                            <input type="text" id="editDriverMake">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Model</label>
                            <input type="text" id="editDriverModel">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Color</label>
                            <input type="text" id="editDriverColor">
                        </div>
                        <div class="form-group">
                            <label>Assigned City</label>
                            <select id="editDriverCity">
                                <option value="">-- No City (Global) --</option>
                                <!-- Dynamic options populated via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Right Column - Photos -->
                    <div>
                        <div class="form-group">
                            <label>Profile Photo</label>
                            <div class="upload-zone" id="editDriverAvatarZone" onclick="document.getElementById('editDriverAvatarInput').click()">
                                <input type="file" id="editDriverAvatarInput" accept="image/*" style="display:none" onchange="previewImage(this, 'editDriverAvatarPreview')">
                                <div id="editDriverAvatarPreview" class="upload-preview">
                                    <span class="upload-icon">üì∑</span>
                                    <span>Click to upload profile photo</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Photo</label>
                            <div class="upload-zone" id="editDriverVehicleZone" onclick="document.getElementById('editDriverVehicleInput').click()">
                                <input type="file" id="editDriverVehicleInput" accept="image/*" style="display:none" onchange="previewImage(this, 'editDriverVehiclePreview')">
                                <div id="editDriverVehiclePreview" class="upload-preview">
                                    <span class="upload-icon">üöó</span>
                                    <span>Click to upload vehicle photo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditDriver()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Driver Modal -->
    <div id="createDriverModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>Create New Driver</h3>
            <form id="createDriverForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Left Column - Basic Info -->
                    <div>
                        <div class="form-group">
                            <label>DID (Bluesky)</label>
                            <input type="text" id="createDriverDid" placeholder="did:plc:..." required>
                            <small style="color: #6b7280;">e.g., did:plc:cakurfpvnvbtgzwazeriujxn</small>
                        </div>
                        <div class="form-group">
                            <label>Handle (Bluesky)</label>
                            <input type="text" id="createDriverHandle" placeholder="username.bsky.social" required>
                        </div>
                        <div class="form-group">
                            <label>Display Name</label>
                            <input type="text" id="createDriverDisplayName" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Type</label>
                            <select id="createDriverVehicleType" required>
                                <!-- Dynamic options populated via JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>License Plate</label>
                            <input type="text" id="createDriverPlate" required>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Make</label>
                            <input type="text" id="createDriverMake" placeholder="Toyota">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Model</label>
                            <input type="text" id="createDriverModel" placeholder="Camry">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Color</label>
                            <input type="text" id="createDriverColor" placeholder="Silver">
                        </div>
                        <div class="form-group">
                            <label>Vehicle Year</label>
                            <input type="number" id="createDriverYear" min="1990" max="2099" placeholder="2024">
                        </div>
                        <div class="form-group">
                            <label>Service Type</label>
                            <select id="createDriverAvailability">
                                <option value="BOTH">Ride & Delivery</option>
                                <option value="RIDE">Ride Only</option>
                                <option value="DELIVERY">Delivery Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Assigned City</label>
                            <select id="createDriverCity">
                                <option value="">-- No City (Global) --</option>
                                <!-- Dynamic options populated via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Right Column - Photos -->
                    <div>
                        <div class="form-group">
                            <label>Profile Photo</label>
                            <div class="upload-zone" id="createDriverAvatarZone" onclick="document.getElementById('createDriverAvatarInput').click()">
                                <input type="file" id="createDriverAvatarInput" accept="image/*" style="display:none" onchange="previewImage(this, 'createDriverAvatarPreview')">
                                <div id="createDriverAvatarPreview" class="upload-preview">
                                    <span class="upload-icon">üì∑</span>
                                    <span>Click to upload profile photo</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Vehicle Photo</label>
                            <div class="upload-zone" id="createDriverVehicleZone" onclick="document.getElementById('createDriverVehicleInput').click()">
                                <input type="file" id="createDriverVehicleInput" accept="image/*" style="display:none" onchange="previewImage(this, 'createDriverVehiclePreview')">
                                <div id="createDriverVehiclePreview" class="upload-preview">
                                    <span class="upload-icon">üöó</span>
                                    <span>Click to upload vehicle photo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateDriver()">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Driver</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="createOrderModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>Create New Order</h3>
            <form id="createOrderForm">
                <!-- User Selection -->
                <div class="form-group">
                    <label>User DID (Bluesky)</label>
                    <input type="text" id="createOrderUserDid" placeholder="did:plc:..." required>
                    <small style="color: #6b7280;">Enter the customer's Bluesky DID</small>
                </div>

                <!-- Order Type -->
                <div class="form-group">
                    <label>Order Type</label>
                    <select id="createOrderType" onchange="toggleDeliveryFields()" required>
                        <option value="RIDE">üöó Ride</option>
                        <option value="DELIVERY">üì¶ Delivery</option>
                    </select>
                </div>

                <!-- Vehicle Type -->
                <div class="form-group">
                    <label>Vehicle Type</label>
                    <select id="createOrderVehicleType">
                        <option value="ECONOMY">Economy</option>
                        <option value="COMFORT">Comfort</option>
                        <option value="PREMIUM">Premium</option>
                        <option value="XL">XL</option>
                        <option value="MOTO">Moto</option>
                        <option value="BIKE">Bike</option>
                    </select>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 15px;">üìç Pickup Location</h4>

                <div class="form-group">
                    <label>Pickup Address</label>
                    <input type="text" id="createOrderPickupAddress" placeholder="123 Main St, City" required>
                </div>
                <div class="form-group">
                    <label>Pickup Name (optional)</label>
                    <input type="text" id="createOrderPickupName" placeholder="Home, Office, etc.">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Pickup Latitude</label>
                        <input type="number" id="createOrderPickupLat" step="any" placeholder="40.7128" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Pickup Longitude</label>
                        <input type="number" id="createOrderPickupLon" step="any" placeholder="-74.0060" required>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 15px;">üìç Dropoff Location</h4>

                <div class="form-group">
                    <label>Dropoff Address</label>
                    <input type="text" id="createOrderDropoffAddress" placeholder="456 Oak Ave, City" required>
                </div>
                <div class="form-group">
                    <label>Dropoff Name (optional)</label>
                    <input type="text" id="createOrderDropoffName" placeholder="Airport, Mall, etc.">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Dropoff Latitude</label>
                        <input type="number" id="createOrderDropoffLat" step="any" placeholder="40.7580" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Dropoff Longitude</label>
                        <input type="number" id="createOrderDropoffLon" step="any" placeholder="-73.9855" required>
                    </div>
                </div>

                <!-- Pricing -->
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 15px;">üí∞ Pricing (Optional)</h4>
                <div class="form-group">
                    <label>Estimated Fare ($)</label>
                    <input type="number" id="createOrderFare" step="0.01" placeholder="Auto-calculated if empty">
                    <small style="color: #6b7280;">Leave empty to auto-calculate based on distance</small>
                </div>

                <!-- Delivery Fields (hidden by default) -->
                <div id="deliveryFields" style="display: none;">
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                    <h4 style="margin-bottom: 15px;">üì¶ Delivery Details</h4>
                    
                    <div class="form-group">
                        <label>Package Size</label>
                        <select id="createOrderPackageSize">
                            <option value="SMALL">Small (fits in hand)</option>
                            <option value="MEDIUM" selected>Medium (fits in bag)</option>
                            <option value="LARGE">Large (needs trunk)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Package Description</label>
                        <input type="text" id="createOrderPackageDesc" placeholder="Documents, food, electronics...">
                    </div>
                    <div class="form-group">
                        <label>Recipient Name</label>
                        <input type="text" id="createOrderRecipientName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Recipient Phone</label>
                        <input type="text" id="createOrderRecipientPhone" placeholder="+1 555-1234">
                    </div>
                    <div class="form-group">
                        <label>Delivery Instructions</label>
                        <textarea id="createOrderDeliveryInstructions" placeholder="Leave at door, call on arrival..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; min-height: 60px;"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateOrder()">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vehicle Type Modal (Create/Edit) -->
    <div id="vehicleTypeModal" class="modal">
        <div class="modal-content">
            <h3 id="vehicleTypeModalTitle">Add Vehicle Type</h3>
            <form id="vehicleTypeForm">
                <input type="hidden" id="vehicleTypeId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Code *</label>
                        <input type="text" id="vehicleTypeCode" placeholder="ECONOMY" required style="text-transform: uppercase;">
                        <small style="color: #6b7280;">Unique identifier (uppercase)</small>
                    </div>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="vehicleTypeName" placeholder="Go" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="vehicleTypeDescription" placeholder="Affordable, everyday rides">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Icon (Emoji)</label>
                        <input type="text" id="vehicleTypeIcon" placeholder="üöó" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="vehicleTypeCapacity" value="4" min="1" max="20">
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 15px;">üí∞ Pricing</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Base Fare ($)</label>
                        <input type="number" id="vehicleTypeBaseFare" value="2.50" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Per KM Rate ($)</label>
                        <input type="number" id="vehicleTypePerKm" value="1.20" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Per Minute Rate ($)</label>
                        <input type="number" id="vehicleTypePerMin" value="0.15" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Minimum Fare ($)</label>
                        <input type="number" id="vehicleTypeMinFare" value="5.00" step="0.01" min="0">
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                <h4 style="margin-bottom: 15px;">‚öôÔ∏è Display Settings</h4>

                <div class="form-group">
                    <label>Features (comma-separated)</label>
                    <input type="text" id="vehicleTypeFeatures" placeholder="4 seats, AC, Extra legroom">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="vehicleTypeSortOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Active</label>
                        <select id="vehicleTypeActive">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Promo</label>
                        <select id="vehicleTypeIsPromo" onchange="togglePromoText()">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="promoTextGroup" style="display: none;">
                    <label>Promo Text</label>
                    <input type="text" id="vehicleTypePromoText" placeholder="Most popular">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeVehicleTypeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cities Section -->
    <div id="cities" class="section">
        <h2>üèôÔ∏è Cities & Regional Pricing</h2>
        <div id="citiesMessage" class="message"></div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="loadCities()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="showCityForm()">‚ûï Add City</button>
            <button class="btn btn-secondary" onclick="seedCities()">üå± Seed Default Cities</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Country</th>
                    <th>Center</th>
                    <th>Radius</th>
                    <th>Drivers</th>
                    <th>Orders</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="citiesBody"></tbody>
        </table>
    </div>

    <!-- Market Section -->
    <div id="market" class="section">
        <h2>üõçÔ∏è Market Management</h2>
        <div id="marketMessage" class="message"></div>
        
        <!-- Market Stats -->
        <div class="stats-grid" id="marketStatsGrid">
            <div class="stat-card purple">
                <div class="stat-label">Total Sellers</div>
                <div class="stat-value" id="statMarketSellers">-</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">Pending Sellers</div>
                <div class="stat-value" id="statMarketPendingSellers">-</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-label">Total Posts</div>
                <div class="stat-value" id="statMarketPosts">-</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Pending Posts</div>
                <div class="stat-value" id="statMarketPendingPosts">-</div>
            </div>
        </div>
        
        <!-- Market Subtabs -->
        <div class="tabs" style="margin-top: 20px;">
            <button class="tab active" id="marketSubtabCategories" onclick="showMarketSubtab('categories')">üìÅ Categories</button>
            <button class="tab" id="marketSubtabPromoCards" onclick="showMarketSubtab('promoCards')">üé¥ Promo Cards</button>
            <button class="tab" id="marketSubtabSellers" onclick="showMarketSubtab('sellers')">üë§ Sellers</button>
            <button class="tab" id="marketSubtabPosts" onclick="showMarketSubtab('posts')">üìã Posts</button>
            <button class="tab" id="marketSubtabOrders" onclick="showMarketSubtab('orders')">üì¶ Orders</button>
            <button class="tab" id="marketSubtabDisputes" onclick="showMarketSubtab('disputes')">‚ö†Ô∏è Disputes</button>
            <button class="tab" id="marketSubtabCheckout" onclick="showMarketSubtab('checkout')">üõí Checkout</button>
            <button class="tab" id="marketSubtabSettings" onclick="showMarketSubtab('settings')">‚öôÔ∏è Settings</button>
        </div>
        
        <!-- Categories Subtab -->
        <div id="marketCategories" class="market-subtab">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showCategoryForm()">‚ûï Add Category</button>
                <button class="btn btn-primary" onclick="loadMarketCategories()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Icon</th>
                        <th>Name</th>
                        <th>Name (AR)</th>
                        <th>Subcategories</th>
                        <th>Posts</th>
                        <th>Order</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketCategoriesBody"></tbody>
            </table>
        </div>
        
        <!-- Promo Cards Subtab -->
        <div id="marketPromoCards" class="market-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showPromoCardForm()">‚ûï Add Promo Card</button>
                <button class="btn btn-warning" onclick="seedDefaultPromoCards()">üå± Seed Defaults</button>
                <button class="btn btn-primary" onclick="loadMarketPromoCards()">üîÑ Refresh</button>
            </div>
            
            <p style="margin: 15px 0; color: #6b7280; font-size: 14px;">
                üìê <strong>Position Guide:</strong> 
                <span style="background:#e0f2fe;padding:3px 8px;border-radius:4px;margin:0 5px;">1 = Top Left</span>
                <span style="background:#fef3c7;padding:3px 8px;border-radius:4px;margin:0 5px;">2 = Bottom Left</span>
                <span style="background:#d1fae5;padding:3px 8px;border-radius:4px;margin:0 5px;">3 = Carousel (Right)</span>
            </p>
            
            <table>
                <thead>
                    <tr>
                        <th>Preview</th>
                        <th>Title</th>
                        <th>Emoji</th>
                        <th>Position</th>
                        <th>Carousel #</th>
                        <th>Gradient</th>
                        <th>City</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketPromoCardsBody"></tbody>
            </table>
        </div>
        
        <!-- Sellers Subtab -->
        <div id="marketSellers" class="market-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <input type="search" id="sellerSearch" placeholder="Search sellers..." onkeyup="if(event.key==='Enter')loadMarketSellers()">
                <select id="sellerStatusFilter" onchange="loadMarketSellers()">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="SUSPENDED">Suspended</option>
                </select>
                <button class="btn btn-primary" onclick="loadMarketSellers()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Store Name</th>
                        <th>User</th>
                        <th>Contact</th>
                        <th>Posts</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketSellersBody"></tbody>
            </table>
            <div id="marketSellersPagination" class="pagination"></div>
        </div>
        
        <!-- Posts Subtab -->
        <div id="marketPosts" class="market-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <input type="search" id="postSearch" placeholder="Search posts..." onkeyup="if(event.key==='Enter')loadMarketPosts()">
                <select id="postStatusFilter" onchange="loadMarketPosts()">
                    <option value="">All Status</option>
                    <option value="PENDING_REVIEW">Pending Review</option>
                    <option value="ACTIVE">Active</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="SOLD">Sold</option>
                    <option value="REMOVED">Removed</option>
                </select>
                <select id="postCategoryFilter" onchange="loadMarketPosts()">
                    <option value="">All Categories</option>
                </select>
                <select id="postCityFilter" onchange="loadMarketPosts()">
                    <option value="">All Cities</option>
                    <!-- Populated by JS -->
                </select>
                <button class="btn btn-primary" onclick="loadMarketPosts()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Seller</th>
                        <th>Category</th>
                        <th>City</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketPostsBody"></tbody>
            </table>
            <div id="marketPostsPagination" class="pagination"></div>
        </div>

        <!-- Market Orders Subtab -->
        <div id="marketOrders" class="market-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <input type="search" id="marketOrderSearch" placeholder="Search orders (ID, buyer)..." onkeyup="if(event.key==='Enter')loadMarketOrders()">
                <select id="marketOrderStatusFilter" onchange="loadMarketOrders()">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="PAID">Paid</option>
                    <option value="PROCESSING">Processing</option>
                    <option value="SHIPPED">Shipped</option>
                    <option value="DELIVERED">Delivered</option>
                    <option value="CANCELLED">Cancelled</option>
                    <option value="REFUNDED">Refunded</option>
                </select>
                <button class="btn btn-primary" onclick="loadMarketOrders()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Buyer</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Escrow</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="marketOrdersBody"></tbody>
            </table>
            <div id="marketOrdersPagination" class="pagination"></div>
        </div>

        <!-- Disputes Subtab -->
        <div id="disputes" class="market-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <select id="disputeStatusFilter" onchange="loadDisputes()">
                    <option value="">All Status</option>
                    <option value="OPEN">Open</option>
                    <option value="UNDER_REVIEW">Under Review</option>
                    <option value="RESOLVED">Resolved</option>
                </select>
                <button class="btn btn-primary" onclick="loadDisputes()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Dispute ID</th>
                        <th>Order</th>
                        <th>Initiated By</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Escrow Amount</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="disputesBody"></tbody>
            </table>
            <div id="disputesPagination" class="pagination"></div>
        </div>

        <!-- Checkout Subtab -->
        <div id="marketCheckout" class="market-subtab" style="display: none;">
            <div style="margin-top: 20px;">
                
                <!-- Checkout Config Section -->
                <div style="margin-bottom: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #374151;">üöö Checkout Configuration</h3>
                        <div>
                            <select id="checkoutConfigCityFilter" onchange="loadCheckoutConfigForCity()" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-right: 10px;">
                                <option value="">Global (Default)</option>
                            </select>
                            <button class="btn btn-success" onclick="saveCheckoutConfig()">üíæ Save Config</button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        
                        <!-- Shipping & Fees -->
                        <div class="settings-panel" style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 1px solid #86efac;">
                            <h4 style="margin-bottom: 15px; color: #166534;">üì¶ Shipping & Fees</h4>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Default Shipping Fee (MAD)</label>
                                <input type="number" id="checkoutDefaultShippingFee" min="0" step="1" value="15" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Free Shipping Above (MAD)</label>
                                <input type="number" id="checkoutFreeShippingThreshold" min="0" step="1" placeholder="No free shipping" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutCodEnabled" checked style="width: 16px; height: 16px;">
                                    <span>Enable Cash on Delivery</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutCodFeeEnabled" checked style="width: 16px; height: 16px;">
                                    <span>Charge COD Extra Fee</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>COD Fee Amount (MAD)</label>
                                <input type="number" id="checkoutCodFeeAmount" min="0" step="1" value="5" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <!-- Payment Methods -->
                        <div class="settings-panel" style="background: #eff6ff; padding: 20px; border-radius: 12px; border: 1px solid #93c5fd;">
                            <h4 style="margin-bottom: 15px; color: #1e40af;">üí≥ Payment Methods</h4>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutWalletEnabled" checked style="width: 16px; height: 16px;">
                                    <span>üí∞ Wallet Payment</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutCardEnabled" checked style="width: 16px; height: 16px;">
                                    <span>üí≥ Card Payment</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutCodPaymentEnabled" checked style="width: 16px; height: 16px;">
                                    <span>üíµ Cash on Delivery</span>
                                </label>
                                <small style="color: #6b7280; margin-left: 24px;">Same as "Enable COD" above</small>
                            </div>
                        </div>
                        
                        <!-- Required Address Fields -->
                        <div class="settings-panel" style="background: #fef3c7; padding: 20px; border-radius: 12px; border: 1px solid #fcd34d;">
                            <h4 style="margin-bottom: 15px; color: #92400e;">üìç Required Address Fields</h4>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequireFullName" checked style="width: 16px; height: 16px;">
                                    <span>Full Name</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequirePhone" checked style="width: 16px; height: 16px;">
                                    <span>Phone Number</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequireStreet" checked style="width: 16px; height: 16px;">
                                    <span>Street Address</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequireCity" checked style="width: 16px; height: 16px;">
                                    <span>City</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequireState" style="width: 16px; height: 16px;">
                                    <span>State/Province</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="checkoutRequirePostalCode" style="width: 16px; height: 16px;">
                                    <span>Postal Code</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label>Default Country</label>
                                <input type="text" id="checkoutDefaultCountry" value="Morocco" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 8px;">
                            </div>
                        </div>
                        
                        <!-- Order Limits -->
                        <div class="settings-panel" style="background: #fdf2f8; padding: 20px; border-radius: 12px; border: 1px solid #f9a8d4;">
                            <h4 style="margin-bottom: 15px; color: #9d174d;">üîí Order Limits</h4>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Minimum Order (MAD)</label>
                                <input type="number" id="checkoutMinOrderAmount" min="0" step="1" placeholder="No minimum" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            
                            <div class="form-group">
                                <label>Maximum Order (MAD)</label>
                                <input type="number" id="checkoutMaxOrderAmount" min="0" step="1" placeholder="No maximum" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Promo Codes Section -->
                <div style="border-top: 2px solid #e5e7eb; padding-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #374151;">üéüÔ∏è Promo Codes</h3>
                        <div>
                            <select id="promoCodeCityFilter" onchange="loadPromoCodes()" style="padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-right: 10px;">
                                <option value="">All Cities</option>
                            </select>
                            <button class="btn btn-success" onclick="showPromoCodeForm()">‚ûï Add Promo Code</button>
                            <button class="btn btn-primary" onclick="loadPromoCodes()">üîÑ Refresh</button>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Value</th>
                                <th>Min Order</th>
                                <th>Usage</th>
                                <th>Validity</th>
                                <th>City</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="promoCodesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Subtab -->
        <div id="marketSettings" class="market-subtab" style="display: none;">
            <form id="marketSettingsForm" style="margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                    
                    <!-- Tax Settings -->
                    <div class="settings-panel" style="background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 20px; color: #374151;">üí∞ Tax Settings (TVA)</h3>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="settingsTvaEnabled" style="width: 18px; height: 18px;">
                                <span>Enable TVA</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>TVA Rate (%)</label>
                            <input type="number" id="settingsTvaRate" min="0" max="100" step="1" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <small style="color: #6b7280;">Enter as percentage (e.g., 20 for 20%)</small>
                        </div>
                    </div>
                    
                    <!-- Service Fee Settings -->
                    <div class="settings-panel" style="background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 20px; color: #374151;">üè∑Ô∏è Service Fee (Platform Commission)</h3>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="settingsServiceFeeEnabled" style="width: 18px; height: 18px;">
                                <span>Enable Service Fee</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label>Service Fee Rate (%)</label>
                            <input type="number" id="settingsServiceFeeRate" min="0" max="50" step="1" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Min Fee</label>
                                <input type="number" id="settingsServiceFeeMin" min="0" step="1" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                            <div class="form-group">
                                <label>Max Fee (optional)</label>
                                <input type="number" id="settingsServiceFeeMax" min="0" step="1" placeholder="No limit" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Currency Settings -->
                    <div class="settings-panel" style="background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 20px; color: #374151;">üåç General Settings</h3>
                        
                        <div class="form-group">
                            <label>Default Currency</label>
                            <select id="settingsDefaultCurrency" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="MAD">MAD - Moroccan Dirham</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <small style="color: #6b7280;">Changes will take effect immediately for all new transactions</small>
                    <button type="submit" class="btn btn-success">üíæ Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Market Category Form Modal -->
    <div id="categoryFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="categoryFormTitle">Add Category</h3>
            <form id="categoryForm" enctype="multipart/form-data">
                <input type="hidden" id="categoryId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label>Name (English) *</label>
                            <input type="text" id="categoryName" required placeholder="e.g., Electronics">
                        </div>
                        <div class="form-group">
                            <label>Name (Arabic)</label>
                            <input type="text" id="categoryNameAr" placeholder="e.g., ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™" dir="rtl">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="categoryDescription" placeholder="Brief description">
                        </div>
                        <div class="form-group">
                            <label>Emoji</label>
                            <input type="text" id="categoryEmoji" placeholder="e.g., üì±" maxlength="4">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Icon (SVG/PNG)</label>
                            <div class="upload-zone" id="categoryIconZone" onclick="document.getElementById('categoryIconInput').click()">
                                <input type="file" id="categoryIconInput" name="icon" accept=".svg,.png,.jpg,.jpeg,.webp" style="display:none" onchange="previewCategoryIcon(this)">
                                <div id="categoryIconPreview" class="upload-preview">
                                    <span class="upload-icon">üñºÔ∏è</span>
                                    <span>Click to upload icon</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Gradient Start</label>
                            <input type="color" id="categoryGradientStart" value="#667eea" style="width: 100%; height: 40px;">
                        </div>
                        <div class="form-group">
                            <label>Gradient End</label>
                            <input type="color" id="categoryGradientEnd" value="#764ba2" style="width: 100%; height: 40px;">
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="categorySortOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="categoryIsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="categoryIsFeatured" style="width: 20px; height: 20px;">
                        <span>‚≠ê Featured Category</span>
                    </label>
                    <small style="color: #6b7280; margin-top: 5px; display: block;">Featured categories show their subcategories on the catalog home screen (max 3)</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCategoryForm()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subcategory Form Modal -->
    <div id="subcategoryFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="subcategoryFormTitle">Add Subcategory</h3>
            <form id="subcategoryForm" enctype="multipart/form-data">
                <input type="hidden" id="subcategoryId">
                <input type="hidden" id="subcategoryCategoryId">
                
                <div class="form-group">
                    <label>Parent Category</label>
                    <input type="text" id="subcategoryParentName" disabled style="background: #f9fafb;">
                </div>
                <div class="form-group">
                    <label>Name (English) *</label>
                    <input type="text" id="subcategoryName" required placeholder="e.g., Smartphones">
                </div>
                <div class="form-group">
                    <label>Name (Arabic)</label>
                    <input type="text" id="subcategoryNameAr" placeholder="e.g., ŸáŸàÿßÿ™ŸÅ ÿ∞ŸÉŸäÿ©" dir="rtl">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="subcategoryDescription" placeholder="Brief description">
                </div>
                <div class="form-group">
                    <label>Emoji</label>
                    <input type="text" id="subcategoryEmoji" placeholder="e.g., üì±" maxlength="4">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="subcategorySortOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="subcategoryIsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideSubcategoryForm()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Subcategory</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Promo Card Form Modal -->
    <div id="promoCardFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="promoCardFormTitle">Add Promo Card</h3>
            <form id="promoCardForm" enctype="multipart/form-data">
                <input type="hidden" id="promoCardId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label>Title * (use \n for line breaks)</label>
                            <textarea id="promoCardTitle" required placeholder="e.g., –í—Å—Ç—Ä–µ—á–∞–µ–º&#10;–ù–æ–≤—ã–π –≥–æ–¥&#10;—Å –õ–∞–≤–∫–æ–π" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Title (Arabic)</label>
                            <textarea id="promoCardTitleAr" placeholder="Arabic title" dir="rtl" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Emoji</label>
                            <input type="text" id="promoCardEmoji" placeholder="e.g., üéÑ, üéÅ, üöÄ" maxlength="4">
                        </div>
                        <div class="form-group">
                            <label>Position *</label>
                            <select id="promoCardPosition" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="1">1 - Top Left</option>
                                <option value="2">2 - Bottom Left</option>
                                <option value="3">3 - Carousel (Right)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>City (optional - leave empty for all cities)</label>
                            <select id="promoCardCityId" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="">All Cities (Global)</option>
                                <!-- Cities will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group" id="carouselOrderGroup">
                            <label>Carousel Order (for position 3)</label>
                            <input type="number" id="promoCardCarouselOrder" value="0" min="0">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Background Image (optional)</label>
                            <div class="upload-zone" id="promoCardImageZone" onclick="document.getElementById('promoCardImageInput').click()">
                                <input type="file" id="promoCardImageInput" name="image" accept="image/*" style="display:none" onchange="previewPromoCardImage(this)">
                                <div id="promoCardImagePreview" class="upload-preview">
                                    <span class="upload-icon">üñºÔ∏è</span>
                                    <span>Click to upload image</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Gradient Start</label>
                            <input type="color" id="promoCardGradientStart" value="#667eea" style="width: 100%; height: 40px;">
                        </div>
                        <div class="form-group">
                            <label>Gradient End</label>
                            <input type="color" id="promoCardGradientEnd" value="#764ba2" style="width: 100%; height: 40px;">
                        </div>
                        <div class="form-group">
                            <label>Link URL (optional)</label>
                            <input type="text" id="promoCardLinkUrl" placeholder="e.g., /category/electronics">
                        </div>
                        <div class="form-group">
                            <label>Link Type</label>
                            <select id="promoCardLinkType" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="">None</option>
                                <option value="category">Category</option>
                                <option value="product">Product</option>
                                <option value="url">External URL</option>
                                <option value="promo">Promo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="promoCardSortOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="promoCardIsActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Live Preview -->
                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">Live Preview:</label>
                    <div id="promoCardPreview" style="width: 150px; height: 100px; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; justify-content: space-between; color: white; font-weight: 600; font-size: 12px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        <span id="previewEmoji" style="font-size: 20px;">üéÑ</span>
                        <span id="previewTitle" style="white-space: pre-line; line-height: 1.2;">Sample\nTitle</span>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hidePromoCardForm()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Promo Card</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Seller Details Modal -->
    <div id="sellerDetailsModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">

    <!-- Promo Code Form Modal -->
    <div id="promoCodeFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="promoCodeFormTitle">Add Promo Code</h3>
            <form id="promoCodeForm">
                <input type="hidden" id="promoCodeId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label>Code * (will be uppercase)</label>
                            <input type="text" id="promoCodeCode" required placeholder="e.g., WELCOME10" style="text-transform: uppercase;">
                        </div>
                        
                        <div class="form-group">
                            <label>Type *</label>
                            <select id="promoCodeType" required onchange="updatePromoCodeValueLabel()" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="PERCENTAGE">Percentage (%)</option>
                                <option value="FIXED">Fixed Amount (MAD)</option>
                                <option value="FREE_SHIPPING">Free Shipping</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="promoCodeValueGroup">
                            <label id="promoCodeValueLabel">Discount Value (%)</label>
                            <input type="number" id="promoCodeValue" min="0" step="1" value="10" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Discount (for % off)</label>
                            <input type="number" id="promoCodeMaxDiscount" min="0" step="1" placeholder="No cap" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Min Order Amount (MAD)</label>
                            <input type="number" id="promoCodeMinOrderAmount" min="0" step="1" placeholder="No minimum" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label>Max Total Uses</label>
                            <input type="number" id="promoCodeMaxTotalUses" min="1" step="1" placeholder="Unlimited" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Uses Per User</label>
                            <input type="number" id="promoCodeMaxUsesPerUser" min="1" step="1" value="1" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Valid From</label>
                            <input type="datetime-local" id="promoCodeValidFrom" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Valid Until</label>
                            <input type="datetime-local" id="promoCodeValidUntil" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label>City</label>
                            <select id="promoCodeCityId" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="">All Cities (Global)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select id="promoCodeIsActive" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>Description (admin notes)</label>
                    <textarea id="promoCodeDescription" placeholder="Internal notes about this promo code" rows="2" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hidePromoCodeForm()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Promo Code</button>
                </div>
            </form>
        </div>
    </div>
            <h3>Seller Details</h3>
            <div id="sellerDetailsContent"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideSellerDetails()">Close</button>
            </div>
        </div>
    </div>

    <!-- Post Details Modal -->
    <div id="postDetailsModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3>Post Details</h3>
            <div id="postDetailsContent"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hidePostDetails()">Close</button>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div id="rejectReasonModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 400px;">
            <h3 id="rejectReasonTitle">Rejection Reason</h3>
            <input type="hidden" id="rejectItemId">
            <input type="hidden" id="rejectItemType">
            <div class="form-group">
                <label>Reason *</label>
                <textarea id="rejectReason" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="Enter reason for rejection..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideRejectReasonModal()">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitRejection()">Reject</button>
            </div>
        </div>
    </div>

    <!-- Wallet Section -->
    <div id="wallet" class="section">
        <h2>üí≥ Wallet Management</h2>
        <div id="walletMessage" class="message"></div>
        
        <!-- Wallet Stats -->
        <div class="stats-grid" id="walletStatsGrid">
            <div class="stat-card purple">
                <div class="stat-label">Total Wallets</div>
                <div class="stat-value" id="statWallets">-</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Total Balance</div>
                <div class="stat-value" id="statTotalBalance">-</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-label">Today's Deposits</div>
                <div class="stat-value" id="statTodayDeposits">-</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">Pending Escrow</div>
                <div class="stat-value" id="statPendingEscrow">-</div>
            </div>
        </div>
        
        <!-- Wallet Subtabs -->
        <div class="tabs" style="margin-top: 20px;">
            <button class="tab active" id="walletSubtabDashboard" onclick="showWalletSubtab('dashboard')">üìä Dashboard</button>
            <button class="tab" id="walletSubtabTopup" onclick="showWalletSubtab('topup')">üí≥ Top-Up</button>
            <button class="tab" id="walletSubtabTransactions" onclick="showWalletSubtab('transactions')">üí∞ Transactions</button>
            <button class="tab" id="walletSubtabCashPoints" onclick="showWalletSubtab('cashPoints')">üèß Cash Points</button>
            <button class="tab" id="walletSubtabAgents" onclick="showWalletSubtab('agents')">üë§ Agents</button>
            <button class="tab" id="walletSubtabEscrow" onclick="showWalletSubtab('escrow')">üîê Escrow</button>
            <button class="tab" id="walletSubtabFees" onclick="showWalletSubtab('fees')">üíµ Fees</button>
            <button class="tab" id="walletSubtabSettings" onclick="showWalletSubtab('settings')">‚öôÔ∏è Settings</button>
        </div>
        
        <!-- Top-Up Subtab -->
        <div id="walletTopup" class="wallet-subtab" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                <!-- Search User Panel -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 12px;">
                    <h4 style="margin-bottom: 20px;">üîç Find User</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="topupUserSearch" placeholder="Search by handle, name or DID..." style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <button class="btn btn-primary" onclick="searchUsersForTopup()">Search</button>
                    </div>
                    <div id="topupUserResults" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #6b7280; text-align: center;">Enter a search term to find users</p>
                    </div>
                </div>
                
                <!-- Top-Up Form Panel -->
                <div style="background: #f8fafc; padding: 25px; border-radius: 12px;">
                    <h4 style="margin-bottom: 20px;">üí≥ Top-Up / Deduct</h4>
                    <div id="topupSelectedUser" style="margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; display: none;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" id="topupUserAvatar">?</div>
                            <div>
                                <div style="font-weight: 600;" id="topupUserName">-</div>
                                <div style="font-size: 12px; color: #6b7280;" id="topupUserHandle">-</div>
                                <div style="font-size: 14px; color: #10b981; font-weight: 600; margin-top: 5px;">Balance: <span id="topupUserBalance">0</span> MAD</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="topupFormContainer" style="display: none;">
                        <input type="hidden" id="topupUserDid">
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount (MAD)</label>
                            <input type="number" id="topupAmount" min="0" step="0.01" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Reason</label>
                            <select id="topupReason" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                                <option value="Admin top-up">Admin top-up</option>
                                <option value="Refund">Refund</option>
                                <option value="Bonus">Bonus / Promotion</option>
                                <option value="Compensation">Compensation</option>
                                <option value="Correction">Balance Correction</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Admin Note (optional)</label>
                            <textarea id="topupNote" rows="2" placeholder="Internal note..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="executeTopup()" style="flex: 1; padding: 12px;">‚ûï Add Funds</button>
                            <button class="btn btn-danger" onclick="executeDeduct()" style="flex: 1; padding: 12px;">‚ûñ Deduct Funds</button>
                        </div>
                    </div>
                    
                    <div id="topupPlaceholder" style="text-align: center; color: #6b7280; padding: 40px 0;">
                        <p>üëà Select a user from the search results</p>
                    </div>
                </div>
            </div>
            
            <div id="walletTopupMessage" class="message" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- Dashboard Subtab -->
        <div id="walletDashboard" class="wallet-subtab">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadWalletStats()">üîÑ Refresh Stats</button>
                <button class="btn btn-secondary" onclick="seedWalletDefaults()">üå± Seed Defaults</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">üí∞ Financial Overview</h4>
                    <div id="walletFinancialOverview">
                        <p style="color: #6b7280;">Loading...</p>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">üèß Cash Points Summary</h4>
                    <div id="walletCashPointsSummary">
                        <p style="color: #6b7280;">Loading...</p>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">üìä Recent Activity</h4>
                    <div id="walletRecentActivity">
                        <p style="color: #6b7280;">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transactions Subtab -->
        <div id="walletTransactions" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <input type="search" id="transactionSearch" placeholder="Search by user DID..." style="width: 250px;">
                <select id="transactionTypeFilter" onchange="loadWalletTransactions()">
                    <option value="">All Types</option>
                    <option value="DEPOSIT_CASH">Deposit Cash</option>
                    <option value="DEPOSIT_CARD">Deposit Card</option>
                    <option value="DEPOSIT_BANK">Deposit Bank</option>
                    <option value="WITHDRAWAL_CASH">Withdrawal Cash</option>
                    <option value="WITHDRAWAL_BANK">Withdrawal Bank</option>
                    <option value="PAYMENT_MARKET">Payment Market</option>
                    <option value="PAYMENT_RIDE">Payment Ride</option>
                    <option value="ESCROW_HOLD">Escrow Hold</option>
                    <option value="ESCROW_RELEASE">Escrow Release</option>
                    <option value="REFUND">Refund</option>
                </select>
                <select id="transactionStatusFilter" onchange="loadWalletTransactions()">
                    <option value="">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="PROCESSING">Processing</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="FAILED">Failed</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
                <button class="btn btn-primary" onclick="loadWalletTransactions()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Net</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="walletTransactionsBody"></tbody>
            </table>
            <div id="walletTransactionsPagination" class="pagination"></div>
        </div>
        
        <!-- Cash Points Subtab -->
        <div id="walletCashPoints" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showCashPointForm()">‚ûï Add Cash Point</button>
                <select id="cashPointTypeFilter" onchange="loadWalletCashPoints()">
                    <option value="">All Types</option>
                    <option value="CAFE">‚òï Caf√©</option>
                    <option value="SHOP">üè™ Shop</option>
                    <option value="AGENCY_BARID">üìÆ Barid Bank</option>
                    <option value="AGENCY_WAFACASH">üíµ Wafacash</option>
                    <option value="AGENCY_OTHER">üè¢ Other Agency</option>
                    <option value="ATM">üèß ATM</option>
                </select>
                <select id="cashPointCityFilter" onchange="loadWalletCashPoints()">
                    <option value="">All Cities</option>
                    <!-- Populated by JS -->
                </select>
                <select id="cashPointStatusFilter" onchange="loadWalletCashPoints()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="verified">Verified</option>
                    <option value="unverified">Unverified</option>
                </select>
                <button class="btn btn-primary" onclick="loadWalletCashPoints()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>City</th>
                        <th>Address</th>
                        <th>Agent</th>
                        <th>Deposits</th>
                        <th>Withdrawals</th>
                        <th>Rating</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="walletCashPointsBody"></tbody>
            </table>
        </div>
        
        <!-- Agents Subtab -->
        <div id="walletAgents" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showAgentForm()">‚ûï Add Agent</button>
                <select id="agentStatusFilter" onchange="loadWalletAgents()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="verified">Verified</option>
                    <option value="unverified">Unverified</option>
                </select>
                <button class="btn btn-primary" onclick="loadWalletAgents()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Cash Points</th>
                        <th>Commission %</th>
                        <th>Balance</th>
                        <th>Lifetime Earned</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="walletAgentsBody"></tbody>
            </table>
        </div>
        
        <!-- Escrow Subtab -->
        <div id="walletEscrow" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <select id="escrowStatusFilter" onchange="loadWalletEscrow()">
                    <option value="">All Status</option>
                    <option value="HELD">Held</option>
                    <option value="RELEASED">Released</option>
                    <option value="REFUNDED">Refunded</option>
                    <option value="DISPUTED">Disputed</option>
                </select>
                <button class="btn btn-primary" onclick="loadWalletEscrow()">üîÑ Refresh</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Buyer</th>
                        <th>Seller</th>
                        <th>Order</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Seller Gets</th>
                        <th>Status</th>
                        <th>Release At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="walletEscrowBody"></tbody>
            </table>
        </div>
        
        <!-- Fees Subtab -->
        <div id="walletFees" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showFeeForm()">‚ûï Add Fee Config</button>
                <button class="btn btn-primary" onclick="loadWalletFees()">üîÑ Refresh</button>
            </div>
            
            <p style="margin: 15px 0; color: #6b7280; font-size: 14px;">
                üí° <strong>Fee Types:</strong>
                <span style="background:#e0f2fe;padding:3px 8px;border-radius:4px;margin:0 5px;">PERCENTAGE</span>
                <span style="background:#fef3c7;padding:3px 8px;border-radius:4px;margin:0 5px;">FIXED</span>
                <span style="background:#d1fae5;padding:3px 8px;border-radius:4px;margin:0 5px;">TIERED</span>
            </p>
            
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Value</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Applies To</th>
                        <th>City</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="walletFeesBody"></tbody>
            </table>
        </div>
        
        <!-- Settings Subtab -->
        <div id="walletSettings" class="wallet-subtab" style="display: none;">
            <div class="toolbar" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="showWalletConfigForm()">‚ûï Add Config</button>
                <button class="btn btn-primary" onclick="loadWalletConfigs()">üîÑ Refresh</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Config Table -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">‚öôÔ∏è Wallet Configuration</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Value</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="walletConfigsBody"></tbody>
                    </table>
                </div>
                
                <!-- Quick Settings -->
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                    <h4 style="margin-bottom: 15px;">üîß Quick Settings</h4>
                    <form id="walletQuickSettingsForm">
                        <div class="form-group">
                            <label>Minimum Withdrawal (MAD)</label>
                            <input type="number" id="configMinWithdrawal" min="0" step="1" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Max Daily Withdrawal (MAD)</label>
                            <input type="number" id="configMaxWithdrawalDaily" min="0" step="100" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Max Daily Deposit (MAD)</label>
                            <input type="number" id="configMaxDepositDaily" min="0" step="100" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Escrow Auto-Release Days</label>
                            <input type="number" id="configEscrowReleaseDays" min="1" max="30" step="1" style="width: 100%;">
                        </div>
                        <div class="form-group">
                            <label>Agent Commission Rate (%)</label>
                            <input type="number" id="configAgentCommission" min="0" max="10" step="0.1" style="width: 100%;">
                        </div>
                        <button type="button" class="btn btn-success" onclick="saveQuickSettings()">üíæ Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Point Form Modal -->
    <div id="cashPointFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="cashPointFormTitle">Add Cash Point</h3>
            <input type="hidden" id="cashPointId">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="cashPointName" placeholder="e.g., Caf√© Central">
                    </div>
                    <div class="form-group">
                        <label>Name (Arabic)</label>
                        <input type="text" id="cashPointNameAr" placeholder="ŸÖŸÇŸáŸâ ÿ≥ŸÜÿ™ÿ±ÿßŸÑ" dir="rtl">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="cashPointType">
                            <option value="CAFE">‚òï Caf√©</option>
                            <option value="SHOP">üè™ Shop</option>
                            <option value="AGENCY_BARID">üìÆ Barid Bank</option>
                            <option value="AGENCY_WAFACASH">üíµ Wafacash</option>
                            <option value="AGENCY_OTHER">üè¢ Other Agency</option>
                            <option value="ATM">üèß ATM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <select id="cashPointCity">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="cashPointPhone" placeholder="+212 6XX XXX XXX">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="cashPointAddress" placeholder="123 Main Street">
                    </div>
                    <div class="form-group">
                        <label>Address (Arabic)</label>
                        <input type="text" id="cashPointAddressAr" placeholder="ÿßŸÑÿ¥ÿßÿ±ÿπ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä" dir="rtl">
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="cashPointLat" step="0.000001" placeholder="e.g., 23.7245">
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="cashPointLng" step="0.000001" placeholder="e.g., -15.9301">
                    </div>
                    <div class="form-group">
                        <label>Operating Hours</label>
                        <input type="text" id="cashPointHours" placeholder="8:00-22:00">
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div class="form-group">
                    <label>Daily Deposit Limit</label>
                    <input type="number" id="cashPointDepositLimit" min="0" step="1000" value="50000">
                </div>
                <div class="form-group">
                    <label>Daily Withdrawal Limit</label>
                    <input type="number" id="cashPointWithdrawalLimit" min="0" step="1000" value="20000">
                </div>
                <div class="form-group">
                    <label>Agent</label>
                    <select id="cashPointAgent">
                        <option value="">No Agent</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="cashPointActive" checked>
                    Active
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="cashPointVerified">
                    Verified
                </label>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveCashPoint()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="hideCashPointForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Agent Form Modal -->
    <div id="agentFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="agentFormTitle">Add Agent</h3>
            <input type="hidden" id="agentId">
            
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="agentName" placeholder="Agent name">
            </div>
            <div class="form-group">
                <label>User DID (optional)</label>
                <input type="text" id="agentUserDid" placeholder="did:plc:...">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="agentPhone" placeholder="+212 6XX XXX XXX">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="agentEmail" placeholder="agent@example.com">
            </div>
            <div class="form-group">
                <label>National ID</label>
                <input type="text" id="agentNationalId" placeholder="ID number">
            </div>
            <div class="form-group">
                <label>Commission Rate (%)</label>
                <input type="number" id="agentCommissionRate" min="0" max="10" step="0.1" value="1">
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="agentActive" checked>
                    Active
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="agentVerified">
                    Verified
                </label>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveAgent()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="hideAgentForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Fee Config Form Modal -->
    <div id="feeFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="feeFormTitle">Add Fee Configuration</h3>
            <input type="hidden" id="feeId">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Code (unique)</label>
                    <input type="text" id="feeCode" placeholder="e.g., platform_fee_market">
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="feeName" placeholder="e.g., Market Platform Fee">
                </div>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="feeDescription" placeholder="Description of this fee">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Type</label>
                    <select id="feeType">
                        <option value="PERCENTAGE">Percentage</option>
                        <option value="FIXED">Fixed</option>
                        <option value="TIERED">Tiered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Value</label>
                    <input type="number" id="feeValue" min="0" step="0.1" placeholder="e.g., 8 or 5.00">
                </div>
                <div class="form-group">
                    <label>City (optional)</label>
                    <select id="feeCityId">
                        <option value="">Global (All Cities)</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Min Amount</label>
                    <input type="number" id="feeMinAmount" min="0" step="0.1" placeholder="Optional minimum fee">
                </div>
                <div class="form-group">
                    <label>Max Amount</label>
                    <input type="number" id="feeMaxAmount" min="0" step="0.1" placeholder="Optional maximum fee">
                </div>
            </div>
            
            <div class="form-group">
                <label>Applies To (comma-separated)</label>
                <input type="text" id="feeAppliesTo" placeholder="e.g., DEPOSIT_CASH,WITHDRAWAL_CASH">
            </div>
            
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 15px;">
                <input type="checkbox" id="feeActive" checked>
                Active
            </label>
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveFee()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="hideFeeForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Wallet Config Form Modal -->
    <div id="walletConfigFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="walletConfigFormTitle">Add Configuration</h3>
            <input type="hidden" id="walletConfigId">
            
            <div class="form-group">
                <label>Key</label>
                <input type="text" id="walletConfigKey" placeholder="e.g., min_withdrawal">
            </div>
            <div class="form-group">
                <label>Value</label>
                <input type="text" id="walletConfigValue" placeholder="e.g., 20">
            </div>
            <div class="form-group">
                <label>Description</label>
                <input type="text" id="walletConfigDescription" placeholder="Description of this setting">
            </div>
            <div class="form-group">
                <label>City (optional)</label>
                <select id="walletConfigCityId">
                    <option value="">Global (All Cities)</option>
                    <!-- Populated by JS -->
                </select>
            </div>
            
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 15px;">
                <input type="checkbox" id="walletConfigActive" checked>
                Active
            </label>
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveWalletConfig()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="hideWalletConfigForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Video Feed Section -->
    <div id="videoFeed" class="section">
        <h2>üì∫ Video Feed</h2>
        <div id="videoFeedMessage" class="message"></div>

        <div class="toolbar" style="align-items:center;">
            <input
                type="text"
                id="videoFeedListUriInput"
                placeholder="at://did:plc:.../app.bsky.graph.list/..."
                style="flex:1; min-width: 420px;"
            />
            <button class="btn btn-primary" onclick="loadVideoFeedConfig()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="saveVideoFeedConfig()">üíæ Save</button>
        </div>

        <p style="margin-top: 10px; color:#6b7280; line-height:1.4;">
            Admin format: <strong>AT-URI only</strong>. Example:
            <code>at://did:plc:xxxx/app.bsky.graph.list/yyyy</code>
        </p>
    </div>

    <!-- City Form Modal -->
    <div id="cityFormModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px;">
            <h3 id="cityFormTitle">Add City</h3>
            <input type="hidden" id="cityId">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Left: Form Fields -->
                <div>
                    <div class="form-group">
                        <label>Code (unique identifier)</label>
                        <input type="text" id="cityCode" placeholder="e.g., DAKHLA" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="cityName" placeholder="e.g., Dakhla">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="cityCountry" value="MA" placeholder="e.g., MA">
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <input type="text" id="cityCurrency" value="MAD" placeholder="e.g., MAD">
                    </div>
                    <div class="form-group">
                        <label>Timezone</label>
                        <input type="text" id="cityTimezone" value="Africa/Casablanca">
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="cityLat" step="0.0001" placeholder="Click on map">
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="cityLng" step="0.0001" placeholder="Click on map">
                    </div>
                    <div class="form-group">
                        <label>Service Radius: <span id="radiusValue">50</span> km</label>
                        <input type="range" id="cityRadius" min="5" max="100" value="50" style="width: 100%;" oninput="updateRadiusDisplay()">
                    </div>
                    <div class="form-group">
                        <label>City Image</label>
                        <input type="file" id="cityImage" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="cityActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                
                <!-- Right: Map Picker -->
                <div>
                    <label>Click on map to set city center:</label>
                    <div id="cityMapPicker" style="height: 400px; border-radius: 8px; margin-top: 8px; border: 1px solid #e5e7eb;"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        The circle shows the service radius. Users outside this area will see "Service unavailable".
                    </p>
                </div>
            </div>
            
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveCity()">üíæ Save City</button>
                <button class="btn btn-secondary" onclick="hideCityForm()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- City Pricing Modal -->
    <div id="cityPricingModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 800px;">
            <h3>üí∞ Pricing for <span id="pricingCityName"></span></h3>
            <input type="hidden" id="pricingCityId">
            
            <div class="toolbar" style="margin-bottom: 15px;">
                <button class="btn btn-secondary" onclick="seedCityPricing()">üå± Seed from Global Pricing</button>
            </div>
            
            <div id="pricingVehicleTypes"></div>
            
            <div class="form-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="hideCityPricingModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Walkthrough (Cinematic Tour) Modal -->
    <div id="walkthroughModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <h3>üé¨ City Tour for <span id="walkthroughCityName"></span></h3>
            
            <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; margin-top: 20px;">
                <!-- Map -->
                <div>
                    <div id="walkthroughMapPicker" style="width: 100%; height: 500px; border-radius: 8px; overflow: hidden;"></div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">Click on the map to add waypoints. Drag to explore.</p>
                </div>
                
                <!-- Controls -->
                <div>
                    <!-- Tour Settings -->
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">Tour Settings</h4>
                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 12px; color: #666;">Tour Name</label>
                            <input type="text" id="walkthroughName" placeholder="e.g. Discover Dakhla" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="font-size: 12px; color: #666;">Default Duration per Segment (ms)</label>
                            <input type="number" id="walkthroughDuration" value="3000" min="1000" step="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="walkthroughActive" checked>
                            <label for="walkthroughActive" style="font-size: 12px;">Active</label>
                        </div>
                    </div>
                    
                    <!-- Default Point Settings -->
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">Default for New Points</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div>
                                <label style="font-size: 10px; color: #666;">Zoom</label>
                                <input type="number" id="walkthroughPointZoom" value="14" min="8" max="20" step="0.5" style="width: 100%; padding: 6px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 10px; color: #666;">Pitch</label>
                                <input type="number" id="walkthroughPointPitch" value="60" min="0" max="85" step="5" style="width: 100%; padding: 6px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 10px; color: #666;">Bearing</label>
                                <input type="number" id="walkthroughPointBearing" value="0" min="0" max="360" step="15" style="width: 100%; padding: 6px; font-size: 12px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Points List -->
                    <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; max-height: 250px; overflow-y: auto;">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">Waypoints</h4>
                        <div id="walkthroughPointsList"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: space-between;">
                <div>
                    <button class="btn" style="background: #8b5cf6; color: white;" onclick="previewWalkthrough()">‚ñ∂Ô∏è Preview Tour</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="deleteWalkthrough()">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary" onclick="hideWalkthroughModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveWalkthrough()">üíæ Save Tour</button>
                </div>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
</body>
</html>
