// GoMiniApp Database Schema
// Scalable, multi-tenant architecture for ride-hailing and future mini-apps

generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
}

// =============================================================================
// GLOBAL APP CONFIG
// =============================================================================

model AppConfig {
  id               Int      @id @default(1)
  videoFeedListUri String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// =============================================================================
// SHARED: Users & Authentication
// =============================================================================

model User {
  id            String    @id @default(cuid())
  did           String    @unique // Bluesky DID (did:plc:xxx)
  handle        String?   // Bluesky handle (@user.bsky.social)
  pushToken     String?   // Expo push notification token
  pushTokenUpdatedAt DateTime?
  
  // Profile (cached from Bluesky)
  displayName   String?
  avatarUrl     String?
  
  // Role
  role          String    @default("USER") // USER, ADMIN
  
  // Settings
  defaultPaymentMethod String?
  
  // Preferred City (for Market/Discover/Go)
  preferredCityId String?
  preferredCity   City?    @relation("UserPreferredCity", fields: [preferredCityId], references: [id])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  driver        Driver?
  marketSeller  MarketSeller?
  cart          Cart?
  ordersAsUser  Order[]   @relation("UserOrders")
  ordersAsDriver Order[]  @relation("DriverOrders")
  ratings       Rating[]  @relation("RatingsGiven")
  ratingsReceived Rating[] @relation("RatingsReceived")
  savedPlaces   SavedPlace[]
  savedAddresses UserAddress[]

  @@index([did])
  @@index([pushToken])
}

model SavedPlace {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String   // home, work, gym, etc.
  name        String
  address     String
  latitude    Float
  longitude   Float
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model UserAddress {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String   // home, work, office, etc.
  fullName    String
  phone       String
  street      String
  city        String
  state       String?
  postalCode  String?
  country     String   @default("Morocco")
  
  isDefault   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}

// =============================================================================
// GO SERVICE: Cities & Regional Pricing
// =============================================================================

model City {
  id          String   @id @default(cuid())
  code        String   @unique  // e.g., "DAKHLA", "LAAYOUNE", "CASA"
  name        String             // "Dakhla", "La√¢youne", "Casablanca"
  country     String   @default("MA")
  timezone    String?  @default("Africa/Casablanca")
  currency    String   @default("MAD")
  isActive    Boolean  @default(true)
  
  // ===========================================
  // GEOFENCING - Circle-based (simple)
  // ===========================================
  centerLatitude  Float
  centerLongitude Float
  radiusKm        Float    @default(50)  // Service radius from center
  
  // ===========================================
  // GEOFENCING - Polygon-based (advanced)
  // For irregular city boundaries (Yandex-style)
  // Store as JSON array of [lng, lat] coordinates
  // ===========================================
  boundaryPolygon Json?    // [[lng1,lat1], [lng2,lat2], ...] GeoJSON-style
  usePolygonBoundary Boolean @default(false)  // If true, use polygon instead of radius
  
  // ===========================================
  // SERVICE FEATURE FLAGS
  // Control which services are available per city
  // ===========================================
  enabledServices String[] @default(["market", "rides", "delivery"])  // market, rides, delivery, food
  
  // ===========================================
  // CROSS-CITY CONFIGURATION
  // ===========================================
  allowCrossCityOrders Boolean @default(false)  // Can orders pickup/dropoff in different cities?
  linkedCityIds        String[] @default([])    // Cities this city can do cross-city with
  
  // Display
  imageUrl    String?  // City banner/background image
  
  // Relations
  pricing     CityVehiclePricing[]
  drivers     Driver[]
  orders      Order[]
  walkthrough CityWalkthrough?
  
  // Market Relations
  marketSellers     MarketSeller[]
  marketPosts       MarketPost[]
  marketPromoCards  MarketPromoCard[]
  marketSections    MarketSection[]
  usersPreferred    User[]  @relation("UserPreferredCity")
  checkoutConfigs   CheckoutConfig[]  @relation("CheckoutConfigCity")
  promoCodes        PromoCode[]       @relation("PromoCodeCity")
  
  // Cross-city pricing
  crossCityPricingFrom CrossCityPricing[] @relation("FromCity")
  crossCityPricingTo   CrossCityPricing[] @relation("ToCity")
  
  // Wallet Relations
  cashPoints        CashPoint[]
  walletFeeConfigs  WalletFeeConfig[] @relation("CityFeeConfigs")
  walletConfigs     WalletConfig[]    @relation("CityWalletConfigs")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([centerLatitude, centerLongitude])
}

// =============================================================================
// GO SERVICE: City Walkthrough (Cinematic Tour)
// =============================================================================

model CityWalkthrough {
  id          String   @id @default(cuid())
  cityId      String   @unique
  city        City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  
  name        String?  // Optional name for the tour, e.g., "Dakhla Discovery"
  isActive    Boolean  @default(true)
  
  // Animation settings
  defaultDurationMs Int @default(3000)  // Default time per segment if not specified per point
  
  // Waypoints
  points      WalkthroughPoint[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WalkthroughPoint {
  id              String   @id @default(cuid())
  walkthroughId   String
  walkthrough     CityWalkthrough @relation(fields: [walkthroughId], references: [id], onDelete: Cascade)
  
  // Position in sequence (1, 2, 3...)
  order           Int
  
  // Camera position
  latitude        Float
  longitude       Float
  zoom            Float    @default(14)
  pitch           Float    @default(60)   // Tilt angle (0 = top-down, 60 = cinematic)
  bearing         Float    @default(0)    // Rotation/heading in degrees
  
  // Animation to this point
  durationMs      Int?     // Override walkthrough default if set
  
  // Optional label for admin reference
  label           String?  // e.g., "Marina View", "Old Town"
  
  // Rich content for tour stop display
  title           String?  // Display title shown during tour stop
  description     String?  // Description text shown during tour stop
  imageUrl        String?  // Image/media URL for the point
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([walkthroughId, order])
  @@index([walkthroughId])
}

model CityVehiclePricing {
  id              String   @id @default(cuid())
  cityId          String
  city            City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  vehicleTypeCode String   // References VehicleTypeConfig.code (ECONOMY, COMFORT, etc.)
  
  // Pricing overrides for this city
  baseFare        Float
  perKmRate       Float
  perMinuteRate   Float
  minimumFare     Float
  surgeMultiplier Float    @default(1.0)  // Dynamic pricing multiplier
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cityId, vehicleTypeCode])
  @@index([cityId, isActive])
}

// =============================================================================
// CROSS-CITY PRICING
// Special pricing for rides between different cities
// =============================================================================

model CrossCityPricing {
  id              String   @id @default(cuid())
  
  // Route
  fromCityId      String
  fromCity        City     @relation("FromCity", fields: [fromCityId], references: [id], onDelete: Cascade)
  toCityId        String
  toCity          City     @relation("ToCity", fields: [toCityId], references: [id], onDelete: Cascade)
  vehicleTypeCode String   // ECONOMY, COMFORT, etc.
  
  // Flat rate pricing for intercity
  flatRate        Float?   // If set, use this instead of per-km calculation
  
  // Or distance-based pricing
  baseFare        Float?
  perKmRate       Float?
  minimumFare     Float?
  
  // Estimated trip info (for display)
  estimatedDistanceKm Float?
  estimatedDurationMin Int?
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([fromCityId, toCityId, vehicleTypeCode])
  @@index([fromCityId, isActive])
  @@index([toCityId, isActive])
}

// =============================================================================
// GO SERVICE: Drivers
// =============================================================================

model Driver {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // City assignment
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Availability
  isOnline        Boolean  @default(false)
  availabilityType AvailabilityType @default(BOTH)
  
  // Current Location (updated in real-time)
  currentLatitude  Float?
  currentLongitude Float?
  currentHeading   Float?   // Direction in degrees
  lastLocationUpdate DateTime?
  
  // Vehicle Info
  vehicleMake     String?
  vehicleModel    String?
  vehicleYear     Int?
  vehicleColor    String?
  licensePlate    String?
  vehicleType     String   @default("ECONOMY") // Dynamic vehicle type
  vehicleImageUrl String?   // Primary vehicle image URL
  
  // Stats
  rating          Float    @default(5.0)
  totalRides      Int      @default(0)
  totalDeliveries Int      @default(0)
  totalEarnings   Float    @default(0)
  
  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isOnline, availabilityType])
  @@index([currentLatitude, currentLongitude])
  @@index([cityId])
}

enum AvailabilityType {
  RIDE
  DELIVERY
  BOTH
}

// VehicleType is now dynamic - stored as String and configured via VehicleTypeConfig table

// =============================================================================
// GO SERVICE: Orders (Rides & Deliveries)
// =============================================================================

model Order {
  id              String      @id @default(cuid())
  type            OrderType
  status          OrderStatus @default(PENDING)
  
  // City
  cityId          String?
  city            City?       @relation(fields: [cityId], references: [id])
  
  // Participants
  userId          String
  user            User        @relation("UserOrders", fields: [userId], references: [id])
  driverId        String?
  driver          User?       @relation("DriverOrders", fields: [driverId], references: [id])
  
  // Locations
  pickupLatitude  Float
  pickupLongitude Float
  pickupAddress   String
  pickupName      String?
  
  dropoffLatitude Float
  dropoffLongitude Float
  dropoffAddress  String
  dropoffName     String?
  
  // Route Info
  distanceKm      Float?
  durationMinutes Int?
  polyline        String?     // Encoded polyline for route display
  
  // Pricing
  vehicleType     String      @default("ECONOMY") // Dynamic vehicle type
  estimatedFare   Float
  finalFare       Float?
  surgeMultiplier Float       @default(1.0)
  
  // Delivery-specific
  packageSize     PackageSize?
  packageDescription String?
  isFragile       Boolean     @default(false)
  requiresSignature Boolean   @default(false)
  recipientName   String?
  recipientPhone  String?
  deliveryInstructions String?
  
  // Bluesky DM Integration
  conversationId  String?     // Bluesky conversation ID for order updates
  
  // Timestamps
  requestedAt     DateTime    @default(now())
  acceptedAt      DateTime?
  arrivedAt       DateTime?   // Driver arrived at pickup
  startedAt       DateTime?   // Trip/delivery started
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  cancelledBy     String?     // 'user' | 'driver' | 'system'
  
  // Relations
  events          OrderEvent[]
  rating          Rating?

  @@index([userId, status])
  @@index([driverId, status])
  @@index([status, requestedAt])
  @@index([pickupLatitude, pickupLongitude])
  @@index([cityId])
}

enum OrderType {
  RIDE
  DELIVERY
}

enum OrderStatus {
  PENDING           // Just created, searching for driver
  DRIVER_ASSIGNED   // Driver accepted
  DRIVER_ARRIVING   // Driver en route to pickup
  DRIVER_ARRIVED    // Driver at pickup location
  IN_PROGRESS       // Trip/delivery in progress
  COMPLETED         // Successfully completed
  CANCELLED         // Cancelled by user, driver, or system
}

enum PackageSize {
  SMALL       // Fits in hand
  MEDIUM      // Fits in backpack
  LARGE       // Needs car trunk
  EXTRA_LARGE // Needs van/truck
}

// =============================================================================
// GO SERVICE: Order Events (Real-time Tracking)
// =============================================================================

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  eventType OrderEventType
  
  // Location at time of event
  latitude  Float?
  longitude Float?
  
  // Additional data
  metadata  Json?    // Flexible storage for event-specific data
  
  createdAt DateTime @default(now())

  @@index([orderId, createdAt])
  @@index([eventType])
}

enum OrderEventType {
  CREATED
  DECLINED
  DRIVER_ASSIGNED
  DRIVER_LOCATION_UPDATE
  DRIVER_ARRIVING
  DRIVER_ARRIVED
  TRIP_STARTED
  TRIP_LOCATION_UPDATE
  TRIP_COMPLETED
  CANCELLED
  PAYMENT_PROCESSED
  RATING_SUBMITTED
  TIMEOUT
}

// =============================================================================
// GO SERVICE: Ratings
// =============================================================================

model Rating {
  id          String   @id @default(cuid())
  orderId     String   @unique
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  fromUserId  String
  fromUser    User     @relation("RatingsGiven", fields: [fromUserId], references: [id])
  
  toUserId    String
  toUser      User     @relation("RatingsReceived", fields: [toUserId], references: [id])
  
  rating      Int      // 1-5 stars
  comment     String?
  tipAmount   Float?
  
  createdAt   DateTime @default(now())

  @@index([toUserId])
  @@index([fromUserId])
}

// =============================================================================
// PLATFORM: Mini-App Configurations (Future Extensibility)
// =============================================================================

model MiniApp {
  id          String   @id @default(cuid())
  appId       String   @unique // e.g., "go", "shop", "pay"
  name        String
  description String?
  iconUrl     String?
  isActive    Boolean  @default(true)
  
  // Settings stored as JSON for flexibility
  settings    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// =============================================================================
// GO SERVICE: Vehicle Type Configuration (Admin-managed ride types)
// =============================================================================

model VehicleTypeConfig {
  id            String   @id @default(cuid())
  code          String   @unique // ECONOMY, COMFORT, PREMIUM, XL, MOTO, BIKE, GREEN, etc.
  name          String   // Display name: "Go", "Comfort", "Black", etc.
  description   String   // Short description
  icon          String   // Emoji or icon identifier
  
  // Capacity
  capacity      Int      @default(4) // Number of passengers
  
  // Pricing
  baseFare      Float    @default(2.50)
  perKmRate     Float    @default(1.20)
  perMinuteRate Float    @default(0.15)
  minimumFare   Float    @default(5.00)
  
  // Display settings
  features      String[] @default([]) // ["4 seats", "AC", "Extra legroom"]
  sortOrder     Int      @default(0)  // Display order in UI
  isActive      Boolean  @default(true)
  isPromo       Boolean  @default(false)
  promoText     String?  // "Most popular", "New!", etc.
  
  // Vehicle requirements
  vehicleClass  String?  // For driver filtering: "sedan", "suv", "luxury", etc.
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive, sortOrder])
}

// =============================================================================
// PLATFORM: Push Notification Log (For debugging & analytics)
// =============================================================================

model PushNotificationLog {
  id          String   @id @default(cuid())
  userId      String
  
  title       String
  body        String
  data        Json?
  
  status      String   // 'sent', 'delivered', 'failed'
  errorMessage String?
  
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([status])
}

// =============================================================================
// LAREP: Infrastructure Projects Management
// =============================================================================

model LarepProject {
  id                String   @id @default(cuid())
  name              String   // Project name
  executor          String?  // Project executor/contractor
  budget            Float?   // Budget amount
  budgetCurrency    String   @default("MAD")
  executionPercent  Int      @default(0) // 0-100 percentage of completion
  description       String?  // Project description
  status            LarepProjectStatus @default(PLANNED)
  
  // Location center (for map display)
  centerLatitude    Float?
  centerLongitude   Float?
  
  // Tour/Walkthrough settings
  isPublished       Boolean  @default(false)
  defaultDurationMs Int      @default(3000)
  
  // Relations
  points            LarepProjectPoint[]
  images            LarepProjectImage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
  @@index([isPublished])
}

enum LarepProjectStatus {
  PLANNED       // Not yet started
  IN_PROGRESS   // Currently being executed
  COMPLETED     // Finished
  ON_HOLD       // Temporarily paused
}

model LarepProjectPoint {
  id              String   @id @default(cuid())
  projectId       String
  project         LarepProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Position in sequence (1, 2, 3...)
  order           Int
  
  // Camera position
  latitude        Float
  longitude       Float
  zoom            Float    @default(14)
  pitch           Float    @default(60)
  bearing         Float    @default(0)
  
  // Animation to this point
  durationMs      Int?
  
  // Labels and content
  label           String?  // Admin reference label
  title           String?  // Display title for tour stop
  description     String?  // Description shown during tour
  imageUrl        String?  // Optional image for this point
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([projectId, order])
  @@index([projectId])
}

model LarepProjectImage {
  id          String   @id @default(cuid())
  projectId   String
  project     LarepProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  url         String   // Image URL
  caption     String?  // Image caption
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())

  @@index([projectId])
}

// =============================================================================
// MARKET: Sellers (Verified Publishers)
// =============================================================================

model MarketSeller {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // City (for location-based filtering)
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Store Information
  storeName       String
  storeDescription String?
  contactPhone    String?
  contactEmail    String?
  
  // Verification Status
  status          MarketSellerStatus @default(PENDING)
  verifiedAt      DateTime?
  rejectionReason String?
  
  // Prime Seller Status
  isPrime             Boolean  @default(false)
  primeStatus         PrimeStatus @default(NOT_REQUESTED)
  primeRequestedAt    DateTime?
  primeApprovedAt     DateTime?
  primeRejectionReason String?
  
  // Stripe Connect (for Prime sellers)
  stripeConnectId     String?   // Stripe Connect account ID
  stripeOnboarded     Boolean   @default(false)
  
  // Relations
  posts           MarketPost[]
  orderItems      MarketOrderItem[]
  orderConversations MarketOrderConversation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([isPrime])
  @@index([cityId])
}

enum PrimeStatus {
  NOT_REQUESTED   // Seller hasn't requested Prime
  PENDING         // Awaiting admin approval
  APPROVED        // Prime seller
  REJECTED        // Request rejected
  SUSPENDED       // Prime suspended
}

enum MarketSellerStatus {
  PENDING     // Awaiting admin approval
  APPROVED    // Can publish posts to market
  REJECTED    // Application rejected
  SUSPENDED   // Temporarily suspended
}

// =============================================================================
// MARKET: Posts (Bluesky posts flagged for market display)
// =============================================================================

model MarketPost {
  id              String   @id @default(cuid())
  sellerId        String
  seller          MarketSeller @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  
  // City (for location-based filtering)
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Bluesky Post Reference
  postUri         String   @unique  // at://did:plc:xxx/app.bsky.feed.post/xxx
  postCid         String             // Content ID for the post
  
  // Category
  categoryId      String
  category        MarketCategory @relation(fields: [categoryId], references: [id])
  subcategoryId   String?
  subcategory     MarketSubcategory? @relation(fields: [subcategoryId], references: [id])
  
  // Product Info (cached from post or provided separately)
  title           String
  description     String?
  price           Float?
  currency        String   @default("MAD")
  
  // Inventory Tracking
  quantity        Int      @default(1)
  soldCount       Int      @default(0)
  isInStock       Boolean  @default(true)
  
  // Prime Product (only if seller is Prime and chooses to list as Prime)
  isPrime         Boolean  @default(false)
  
  // Status
  status          MarketPostStatus @default(PENDING_REVIEW)
  reviewedAt      DateTime?
  rejectionReason String?
  
  // Archived (for edits - new post replaces old)
  isArchived      Boolean  @default(false)
  replacedById    String?  // ID of the post that replaced this one
  
  // Relations
  shippingOptions ProductShippingOption[]
  cartItems       CartItem[]
  orderItems      MarketOrderItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sellerId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([status])
  @@index([isArchived])
  @@index([isPrime])
  @@index([cityId])
}

enum MarketPostStatus {
  PENDING_REVIEW  // Awaiting admin approval
  ACTIVE          // Visible in market
  REJECTED        // Rejected by admin
  SOLD            // Marked as sold
  REMOVED         // Removed by seller
}

// =============================================================================
// MARKET: Settings (Admin configurable - TVA, service fees, etc.)
// =============================================================================

model MarketSettings {
  id              Int      @id @default(1) // Singleton
  
  // Tax Settings
  tvaRate         Float    @default(0.20)  // TVA/VAT rate (20% default)
  tvaEnabled      Boolean  @default(true)
  
  // Service Fee (platform commission)
  serviceFeeRate  Float    @default(0.05)  // 5% service fee
  serviceFeeMin   Float    @default(5)     // Minimum service fee (MAD)
  serviceFeeMax   Float?                    // Maximum service fee cap (optional)
  serviceFeeEnabled Boolean @default(true)
  
  // Prime Seller Settings
  primeCommissionRate   Float    @default(0.10)  // 10% commission on Prime sales
  primeMonthlyFee       Float    @default(0)     // Optional monthly Prime subscription
  primeMinimumPayout    Float    @default(100)   // Minimum payout amount
  primeFreeShipping     Boolean  @default(true)  // Free shipping on Prime products
  primeAutoApprove      Boolean  @default(false) // Auto-approve Prime requests
  
  // Currency
  defaultCurrency String   @default("MAD")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// =============================================================================
// MARKET: Checkout Configuration (Admin configurable - per city or global)
// =============================================================================

model CheckoutConfig {
  id                      String   @id @default(cuid())
  
  // City scope (null = global/default, cityId = city-specific override)
  cityId                  String?  @unique
  city                    City?    @relation("CheckoutConfigCity", fields: [cityId], references: [id])
  
  // Shipping/Delivery Settings
  defaultShippingFee      Float    @default(15)        // Default shipping fee (MAD)
  freeShippingThreshold   Float?                       // Free shipping above this amount
  
  // Cash on Delivery Settings
  codEnabled              Boolean  @default(true)      // Enable Cash on Delivery
  codFeeEnabled           Boolean  @default(true)      // Charge extra for COD
  codFeeAmount            Float    @default(5)         // COD extra fee (MAD)
  codFeeType              String   @default("FIXED")   // FIXED or PERCENTAGE
  
  // Payment Methods (which are enabled)
  walletEnabled           Boolean  @default(true)
  cardEnabled             Boolean  @default(true)
  
  // Required Address Fields
  requireFullName         Boolean  @default(true)
  requirePhone            Boolean  @default(true)
  requireStreet           Boolean  @default(true)
  requireCity             Boolean  @default(true)
  requireState            Boolean  @default(false)
  requirePostalCode       Boolean  @default(false)
  requireCountry          Boolean  @default(false)
  
  // Default Country
  defaultCountry          String   @default("Morocco")
  
  // Order Limits
  minOrderAmount          Float?                       // Minimum order amount
  maxOrderAmount          Float?                       // Maximum order amount
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([cityId])
}

// =============================================================================
// MARKET: Promo Codes (Admin configurable discount codes)
// =============================================================================

model PromoCode {
  id                String      @id @default(cuid())
  
  // Code
  code              String      @unique              // e.g., "WELCOME10", "FREESHIP"
  
  // City scope (null = all cities, cityId = city-specific)
  cityId            String?
  city              City?       @relation("PromoCodeCity", fields: [cityId], references: [id])
  
  // Type & Value
  type              PromoType                        // PERCENTAGE, FIXED, FREE_SHIPPING
  value             Float       @default(0)          // Discount value (% or fixed amount)
  
  // Limits
  minOrderAmount    Float?                           // Minimum order to apply promo
  maxDiscount       Float?                           // Cap on discount amount (for percentage)
  
  // Usage Limits
  maxTotalUses      Int?                             // Total uses allowed (null = unlimited)
  maxUsesPerUser    Int         @default(1)          // Uses per user (default: 1)
  totalUsedCount    Int         @default(0)          // Current total usage
  
  // Validity Period
  validFrom         DateTime?                        // Start date (null = immediate)
  validUntil        DateTime?                        // End date (null = no expiry)
  
  // Status
  isActive          Boolean     @default(true)
  
  // Metadata
  description       String?                          // Admin notes
  
  // Relations
  usages            PromoCodeUsage[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([code])
  @@index([cityId, isActive])
  @@index([validFrom, validUntil, isActive])
}

enum PromoType {
  PERCENTAGE        // e.g., 10% off
  FIXED             // e.g., 20 MAD off
  FREE_SHIPPING     // Free shipping
}

// =============================================================================
// MARKET: Promo Code Usage (Track per-user usage)
// =============================================================================

model PromoCodeUsage {
  id                String      @id @default(cuid())
  
  promoCodeId       String
  promoCode         PromoCode   @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  
  userDid           String                           // Bluesky DID of user who used it
  
  // Usage details
  orderId           String?                          // Order where it was applied
  discountAmount    Float                            // Actual discount given
  
  usedAt            DateTime    @default(now())

  @@unique([promoCodeId, userDid, orderId])          // One usage per order
  @@index([promoCodeId])
  @@index([userDid])
}

// =============================================================================
// MARKET: Promo Cards (Admin configurable - Home screen banners)
// =============================================================================

model MarketPromoCard {
  id              String   @id @default(cuid())
  
  // City (for location-based filtering, null = all cities)
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Position: 1=top-left, 2=bottom-left, 3=carousel (right side)
  position        Int      @default(1)
  
  // Content
  title           String              // Card title (supports \n for newlines)
  titleAr         String?             // Arabic title
  emoji           String?             // Emoji icon (e.g., üéÑ, üéÅ, üöÄ)
  
  // Images
  imageUrl        String?             // Optional background image URL
  
  // Gradient colors
  gradientStart   String   @default("#667eea")  // Gradient start color
  gradientEnd     String   @default("#764ba2")  // Gradient end color
  
  // Action
  linkUrl         String?             // Deep link or URL when tapped
  linkType        String?             // "category", "product", "url", etc.
  
  // Carousel specific (for position=3)
  carouselOrder   Int      @default(0)  // Order within the carousel
  
  // Status
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([position, isActive])
  @@index([carouselOrder])
  @@index([cityId])
}

// =============================================================================
// MARKET: App Config (Admin configurable - app icon, branding, etc.)
// =============================================================================

model MarketConfig {
  id              String   @id @default(cuid())
  
  // Branding
  appName         String   @default("Market")
  appNameAr       String?  // Arabic name
  appIconSvg      String?  @db.Text  // SVG content for the market icon
  appIconUrl      String?  // Uploaded icon image URL
  
  // Header Configuration
  headerBgColor   String?  // Custom header background color
  headerTextColor String?  // Custom header text color
  
  // Delivery Banner
  showDeliveryBanner Boolean @default(true)
  deliveryCost    Float?   // e.g., 0 for free delivery, or specific cost
  deliveryTime    String?  // e.g., "20-30 min"
  
  // Feature Toggles
  showCategories  Boolean  @default(true)
  showPromoCards  Boolean  @default(true)
  showSections    Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// =============================================================================
// MARKET: Home Sections (Admin configurable - Featured collections, Ready food, etc.)
// =============================================================================

model MarketSection {
  id              String   @id @default(cuid())
  
  // City (for location-based filtering, null = all cities)
  cityId          String?
  city            City?    @relation(fields: [cityId], references: [id])
  
  // Display
  title           String              // Section title (e.g., "Ready Food", "Fresh Vegetables")
  titleAr         String?             // Arabic title
  subtitle        String?             // Optional subtitle
  subtitleAr      String?             // Arabic subtitle
  
  // Section Type
  sectionType     MarketSectionType @default(GRID)
  
  // Visual
  iconEmoji       String?             // Emoji icon (e.g., üçï, ü•ó)
  iconUrl         String?             // Custom icon URL
  coverImageUrl   String?             // Large cover image for BANNER type
  bgColor         String?             // Background color (hex)
  
  // Content Filtering
  categoryId      String?             // Filter by category
  subcategoryId   String?             // Filter by subcategory
  filterTags      String?             // Comma-separated tags
  productIds      String?             // Specific product IDs (comma-separated) for curated sections
  maxItems        Int      @default(10) // Max items to show
  
  // Layout
  showViewAll     Boolean  @default(true)  // Show "View All" button
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([cityId, isActive, sortOrder])
  @@index([categoryId])
}

enum MarketSectionType {
  GRID          // Grid of products (2 columns)
  HORIZONTAL    // Horizontal scrollable row
  BANNER        // Full-width banner with image
  FEATURED      // Featured items with large cards
  CATEGORY_ROW  // Row of category pills linking to that category
}

// =============================================================================
// MARKET: Shipping Options (per product)
// =============================================================================

model ProductShippingOption {
  id              String   @id @default(cuid())
  postId          String
  post            MarketPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Shipping Type
  type            ShippingType
  name            String           // "Standard Delivery", "Express", "In-Store Pickup"
  description     String?
  
  // Pricing
  price           Float            // Shipping cost (0 for free shipping or pickup)
  freeAbove       Float?           // Free shipping if order above this amount
  
  // Delivery Time
  minDays         Int?             // Minimum delivery days
  maxDays         Int?             // Maximum delivery days
  
  // Availability
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  cartItems       CartItem[]

  @@index([postId, isActive])
}

enum ShippingType {
  PICKUP          // Customer picks up
  LOCAL_DELIVERY  // Same city delivery
  NATIONAL        // National shipping
  INTERNATIONAL   // International shipping
}

// =============================================================================
// MARKET: Shopping Cart
// =============================================================================

model Cart {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Cart Items
  items           CartItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model CartItem {
  id              String   @id @default(cuid())
  cartId          String
  cart            Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  // Product Reference
  postId          String
  post            MarketPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Quantity
  quantity        Int      @default(1)
  
  // Selected Shipping Option
  shippingOptionId String?
  shippingOption   ProductShippingOption? @relation(fields: [shippingOptionId], references: [id])
  
  // Price at time of adding (for history/comparison)
  priceAtAdd      Float
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cartId, postId])  // One entry per product in cart
  @@index([cartId])
  @@index([postId])
}

// =============================================================================
// MARKET: Orders
// =============================================================================

model MarketOrder {
  id                    String            @id @default(cuid())
  buyerDid              String            // Bluesky DID of buyer
  
  // Order Status
  status                MarketOrderStatus @default(PENDING_PAYMENT)
  
  // Pricing
  subtotal              Float             // Sum of item prices
  shippingFee           Float             @default(0)
  serviceFee            Float             @default(0)
  total                 Float             // Final total
  currency              String            @default("MAD")
  
  // Shipping
  shippingAddress       Json?             // {fullName, phone, street, city, state, postalCode, country}
  
  // Payment
  paymentMethod         String            @default("WALLET") // WALLET, CASH_ON_DELIVERY, CARD
  stripePaymentIntentId String?           @unique
  paidAt                DateTime?
  
  // Fulfillment
  shippedAt             DateTime?
  deliveredAt           DateTime?
  
  // Optional message from buyer
  buyerMessage          String?
  
  // Relations
  items                 MarketOrderItem[]
  conversations         MarketOrderConversation[]
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([buyerDid])
  @@index([status])
  @@index([createdAt])
}

// Track conversations per seller for multi-seller orders
model MarketOrderConversation {
  id              String       @id @default(cuid())
  
  orderId         String
  order           MarketOrder  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  sellerId        String
  seller          MarketSeller @relation(fields: [sellerId], references: [id])
  
  // Bluesky conversation ID for DM thread
  conversationId  String
  
  // Message tracking
  orderMessageId  String?      // The message ID containing the order embed
  
  createdAt       DateTime     @default(now())
  
  @@unique([orderId, sellerId])
  @@index([orderId])
  @@index([sellerId])
  @@index([conversationId])
}

enum MarketOrderStatus {
  PENDING_PAYMENT     // Awaiting payment
  PAID                // Payment received
  PROCESSING          // Seller preparing order
  SHIPPED             // Order shipped
  DELIVERED           // Order delivered
  CANCELLED           // Order cancelled
  REFUNDED            // Payment refunded
}

model MarketOrderItem {
  id            String            @id @default(cuid())
  orderId       String
  order         MarketOrder       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Product snapshot (in case product changes/deleted)
  marketPostId  String
  marketPost    MarketPost        @relation(fields: [marketPostId], references: [id])
  sellerId      String
  seller        MarketSeller      @relation(fields: [sellerId], references: [id])
  
  // Bluesky post reference for embedding
  postUri       String?           // at://did:plc:xxx/app.bsky.feed.post/xxx
  postCid       String?           // Content ID for embedding
  
  // Product details at time of purchase
  title         String
  price         Float
  quantity      Int
  total         Float
  
  // Item-level status (for multi-seller orders)
  status        MarketOrderItemStatus @default(PENDING)
  
  // Escrow tracking
  escrowHoldId  String?
  escrowHold    EscrowHold?       @relation(fields: [escrowHoldId], references: [id])
  
  // Dispute
  dispute       MarketOrderDispute?
  
  // Status timestamps
  confirmedAt   DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  createdAt     DateTime          @default(now())

  @@index([orderId])
  @@index([sellerId])
  @@index([marketPostId])
  @@index([escrowHoldId])
}

enum MarketOrderItemStatus {
  PENDING       // Awaiting seller confirmation
  CONFIRMED     // Seller confirmed
  PACKAGED      // Item packaged and ready
  SHIPPED       // Item shipped
  DELIVERED     // Item delivered
  CANCELLED     // Item cancelled
  REFUNDED      // Item refunded
  DISPUTED      // Under dispute
}

// =============================================================================
// MARKET: Order Disputes
// =============================================================================

model MarketOrderDispute {
  id              String   @id @default(cuid())
  
  orderItemId     String   @unique
  orderItem       MarketOrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  
  // Who initiated
  initiatorDid    String              // Buyer or Seller DID
  initiatorType   DisputeInitiator    // BUYER or SELLER
  
  reason          DisputeReason
  description     String?
  evidence        Json?               // Array of image URLs or text
  
  status          DisputeStatus       @default(OPEN)
  
  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?             // Admin DID who resolved
  resolution      DisputeResolution?
  resolutionNote  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([orderItemId])
  @@index([status])
  @@index([initiatorDid])
}

enum DisputeInitiator {
  BUYER
  SELLER
}

enum DisputeReason {
  NOT_RECEIVED              // Buyer: didn't receive item
  ITEM_NOT_AS_DESCRIBED     // Buyer: item different from listing
  DAMAGED_ITEM              // Buyer: item arrived damaged
  WRONG_ITEM                // Buyer: received wrong item
  BUYER_NOT_RESPONDING      // Seller: buyer not responding for delivery
  BUYER_REFUSED_DELIVERY    // Seller: buyer refused to accept
  FRAUDULENT_ORDER          // Seller: suspected fraud
  OTHER
}

enum DisputeStatus {
  OPEN                      // Newly created
  UNDER_REVIEW              // Admin reviewing
  RESOLVED                  // Resolution applied
  CLOSED                    // Closed without action
}

enum DisputeResolution {
  REFUND_BUYER              // Full refund to buyer
  PARTIAL_REFUND            // Partial refund
  RELEASE_TO_SELLER         // Release escrow to seller
  SPLIT                     // Split between both
  NO_ACTION                 // No action taken
}

// =============================================================================
// MARKET: Categories & Subcategories
// =============================================================================

model MarketCategory {
  id              String   @id @default(cuid())
  name            String   @unique
  nameAr          String?  // Arabic name
  description     String?
  
  // Display
  emoji           String?  // Emoji icon (optional)
  iconUrl         String?  // SVG icon URL (admin uploaded)
  gradientStart   String?  // Gradient start color (hex)
  gradientEnd     String?  // Gradient end color (hex)
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  
  // Relations
  subcategories   MarketSubcategory[]
  posts           MarketPost[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive, sortOrder])
}

model MarketSubcategory {
  id              String   @id @default(cuid())
  categoryId      String
  category        MarketCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  name            String
  nameAr          String?  // Arabic name
  description     String?
  
  // Display
  emoji           String?
  iconUrl         String?
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  
  // Relations
  posts           MarketPost[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([categoryId, name])
  @@index([categoryId, isActive, sortOrder])
}

// =============================================================================
// WALLET: Digital Wallet & Payment System
// =============================================================================

model Wallet {
  id              String   @id @default(cuid())
  userDid         String   @unique
  
  // Balances
  balance         Float    @default(0)        // Available balance
  pendingBalance  Float    @default(0)        // Held in escrow
  lifetimeEarned  Float    @default(0)        // Total earned
  lifetimeSpent   Float    @default(0)        // Total spent
  
  currency        String   @default("MAD")
  isActive        Boolean  @default(true)
  isFrozen        Boolean  @default(false)    // Admin can freeze
  
  // Security
  pinHash         String?                     // Hashed PIN
  lastPinChange   DateTime?
  failedPinAttempts Int    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  transactions    WalletTransaction[]
  escrowAsbuyer   EscrowHold[]       @relation("EscrowBuyer")
  escrowAsSeller  EscrowHold[]       @relation("EscrowSeller")
  paymentMethods  PaymentMethod[]

  @@index([userDid])
}

model WalletTransaction {
  id              String   @id @default(cuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id])
  
  type            WalletTransactionType
  amount          Float                       // Original amount
  fee             Float    @default(0)        // Fee charged
  netAmount       Float                       // Amount after fee
  
  status          WalletTransactionStatus @default(PENDING)
  
  // Reference to related entity
  referenceId     String?                     // order_id, ride_id, etc.
  referenceType   String?                     // ORDER, RIDE, DEPOSIT, WITHDRAWAL
  
  // Cash point reference (for cash transactions)
  cashPointId     String?
  cashPoint       CashPoint? @relation(fields: [cashPointId], references: [id])
  
  // Additional data
  description     String?
  metadata        Json?
  
  // Processing
  processedAt     DateTime?
  failureReason   String?
  
  createdAt       DateTime @default(now())

  @@index([walletId, createdAt])
  @@index([type, status])
  @@index([referenceId, referenceType])
}

enum WalletTransactionType {
  DEPOSIT_CASH        // Cash deposited at agent
  DEPOSIT_CARD        // Stripe payment
  DEPOSIT_BANK        // Bank transfer
  WITHDRAWAL_CASH     // Cash pickup
  WITHDRAWAL_BANK     // Bank transfer out
  PAYMENT_MARKET      // Market purchase
  PAYMENT_RIDE        // Ride payment
  REFUND              // Refunded transaction
  ESCROW_HOLD         // Funds held in escrow
  ESCROW_RELEASE      // Funds released from escrow
  FEE_PLATFORM        // Platform fee deduction
  TRANSFER_P2P        // Peer-to-peer transfer
  TRANSFER_IN         // Received P2P transfer
  ADJUSTMENT          // Admin adjustment
}

enum WalletTransactionStatus {
  PENDING             // Awaiting processing
  PROCESSING          // Being processed
  COMPLETED           // Successfully completed
  FAILED              // Failed
  CANCELLED           // Cancelled by user/admin
  REFUNDED            // Refunded
}

model EscrowHold {
  id              String   @id @default(cuid())
  
  buyerWalletId   String
  buyerWallet     Wallet   @relation("EscrowBuyer", fields: [buyerWalletId], references: [id])
  
  sellerWalletId  String
  sellerWallet    Wallet   @relation("EscrowSeller", fields: [sellerWalletId], references: [id])
  
  amount          Float                       // Total held amount
  feeAmount       Float                       // Platform fee to deduct
  sellerAmount    Float                       // Amount seller will receive
  
  // Reference
  orderId         String?
  rideId          String?
  
  // Back relation to order items
  orderItems      MarketOrderItem[]
  
  status          EscrowStatus @default(HELD)
  
  // Timing
  releaseAt       DateTime?                   // Auto-release time
  releasedAt      DateTime?
  
  // Dispute
  disputeReason   String?
  disputedAt      DateTime?
  resolvedAt      DateTime?
  resolution      String?                     // REFUND_BUYER, RELEASE_SELLER, SPLIT
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([buyerWalletId])
  @@index([sellerWalletId])
  @@index([orderId])
  @@index([status])
}

enum EscrowStatus {
  HELD              // Funds are held
  RELEASED          // Released to seller
  REFUNDED          // Refunded to buyer
  DISPUTED          // Under dispute
  PARTIAL_RELEASE   // Partially released (split)
}

// =============================================================================
// WALLET: Cash Points Network
// =============================================================================

model CashPoint {
  id              String   @id @default(cuid())
  
  name            String
  nameAr          String?                     // Arabic name
  type            CashPointType
  
  // Location
  cityId          String
  city            City     @relation(fields: [cityId], references: [id])
  address         String
  addressAr       String?
  latitude        Float
  longitude       Float
  
  // Operating info
  operatingHours  Json?                       // { mon: {open: "09:00", close: "18:00"}, ... }
  phone           String?
  
  // Limits (override global config)
  dailyDepositLimit    Float?
  dailyWithdrawalLimit Float?
  
  // Agent
  agentId         String?
  agent           CashPointAgent? @relation(fields: [agentId], references: [id])
  
  // Status
  isActive        Boolean  @default(true)
  isVerified      Boolean  @default(false)
  
  // Stats
  rating          Float    @default(0)
  ratingCount     Int      @default(0)
  totalDeposits   Float    @default(0)
  totalWithdrawals Float   @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  transactions    WalletTransaction[]

  @@index([cityId, isActive])
  @@index([type, isActive])
  @@index([latitude, longitude])
}

enum CashPointType {
  CAFE              // Local caf√©s
  SHOP              // Convenience stores
  AGENCY_BARID      // Barid Bank
  AGENCY_WAFACASH   // Wafacash
  AGENCY_OTHER      // Other agencies
  ATM               // ATM (future)
}

model CashPointAgent {
  id              String   @id @default(cuid())
  
  userDid         String?                     // Linked user account
  name            String
  phone           String
  email           String?
  nationalId      String?                     // CIN/ID number
  
  // Commission
  commissionRate  Float    @default(0.01)     // 1% default
  
  // Balance (earnings from commissions)
  balance         Float    @default(0)
  lifetimeEarned  Float    @default(0)
  
  // Status
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  // Documents (URLs to uploaded docs)
  documents       Json?                       // { cin: "url", contract: "url" }
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  cashPoints      CashPoint[]

  @@index([userDid])
  @@index([phone])
}

// =============================================================================
// WALLET: Payment Methods & Configuration
// =============================================================================

model PaymentMethod {
  id              String   @id @default(cuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  type            PaymentMethodType
  provider        String?                     // stripe, bank_name
  
  // Card details (masked)
  lastFour        String?
  brand           String?                     // visa, mastercard
  expiryMonth     Int?
  expiryYear      Int?
  
  // Bank details (masked)
  bankName        String?
  accountLastFour String?
  
  // Stripe
  stripePaymentMethodId String?
  
  isDefault       Boolean  @default(false)
  isVerified      Boolean  @default(false)
  
  metadata        Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([walletId])
  @@index([stripePaymentMethodId])
}

enum PaymentMethodType {
  CARD              // Credit/Debit card
  BANK_ACCOUNT      // Bank account
  MOBILE_MONEY      // Mobile money (future)
}

model WalletFeeConfig {
  id              String   @id @default(cuid())
  
  name            String
  code            String   @unique           // platform_fee_market, withdrawal_fee_cash, etc.
  description     String?
  
  type            FeeType
  value           Float                       // Percentage or fixed amount
  minAmount       Float?                      // Minimum fee (for percentage)
  maxAmount       Float?                      // Maximum fee (for percentage)
  
  // Tiered fees (JSON array)
  tiers           Json?                       // [{ upTo: 100, fee: 5 }, { upTo: 500, fee: 3 }]
  
  // Scope
  appliesTo       String[]                    // ['MARKET', 'RIDE', 'WITHDRAWAL', 'DEPOSIT']
  cityId          String?                     // null = global, or city-specific
  city            City?    @relation("CityFeeConfigs", fields: [cityId], references: [id])
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([code, cityId])
  @@index([isActive])
}

enum FeeType {
  PERCENTAGE        // Percentage of amount
  FIXED             // Fixed amount
  TIERED            // Tiered based on amount
}

model WalletConfig {
  id              String   @id @default(cuid())
  
  key             String   @unique           // Config key
  value           String                     // JSON string value
  description     String?
  
  // Scope
  cityId          String?                    // null = global
  city            City?    @relation("CityWalletConfigs", fields: [cityId], references: [id])
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([key, cityId])
}
